<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<!-- 像素事件覆蓋層：升級/成就/掉寶動畫 -->
<div th:fragment="pixelOverlay" x-data="pixelEventOverlay()" x-cloak>

    <!-- 升級動畫 -->
    <template x-if="showLevelUp">
        <div class="fixed inset-0 z-[200] flex items-center justify-center pointer-events-none">
            <div class="text-center anim-flash">
                <div class="text-primary text-[24px] font-heading glow-gold anim-level-up">
                    LEVEL UP!
                </div>
                <div class="text-primary text-[16px] mt-4 font-heading" x-text="'Lv.' + levelUpData.newLevel"></div>
            </div>
        </div>
    </template>

    <!-- 成就解鎖通知 -->
    <template x-for="ach in achievementQueue" :key="ach.key">
        <div class="fixed top-24 right-4 z-[190] pixel-card p-4 max-w-xs anim-slide-in">
            <div class="flex items-center gap-3">
                <div class="text-[20px]">&#9733;</div>
                <div>
                    <div class="text-primary text-[10px] font-heading">成就解鎖！</div>
                    <div class="text-text-heading text-[9px] mt-1" x-text="ach.name"></div>
                    <div class="text-text-muted text-[8px] mt-1" x-text="'+' + ach.exp + ' EXP'"></div>
                </div>
            </div>
        </div>
    </template>

    <!-- 每日獎勵動畫 -->
    <template x-if="showDailyReward">
        <div class="fixed inset-0 z-[200] flex items-center justify-center bg-black/60"
             @click="showDailyReward = false">
            <div class="pixel-card p-6 text-center anim-bounce" @click.stop>
                <div class="text-[24px] mb-3">&#128230;</div>
                <div class="text-primary text-[12px] font-heading mb-2">每日獎勵！</div>
                <div class="text-positive text-[10px]">+15 EXP</div>
                <button @click="showDailyReward = false"
                        class="pixel-btn pixel-btn-gold text-[8px] mt-4">
                    收下！
                </button>
            </div>
        </div>
    </template>

    <script>
        function pixelEventOverlay() {
            return {
                showLevelUp: false,
                levelUpData: {},
                achievementQueue: [],
                showDailyReward: false,

                async init() {
                    try {
                        const resp = await fetch('/api/user/gamification/events');
                        if (!resp.ok) return;
                        const events = await resp.json();
                        if (events.length === 0) return;

                        for (const event of events) {
                            const data = JSON.parse(event.eventData || '{}');
                            if (event.eventType === 'LEVEL_UP') {
                                this.levelUpData = data;
                                this.showLevelUp = true;
                                setTimeout(() => { this.showLevelUp = false; }, 3000);
                            } else if (event.eventType === 'ACHIEVEMENT') {
                                this.achievementQueue.push(data);
                                setTimeout(() => {
                                    this.achievementQueue = this.achievementQueue.filter(a => a.key !== data.key);
                                }, 4000);
                            } else if (event.eventType === 'DAILY_LOGIN') {
                                this.showDailyReward = true;
                            }
                        }

                        // 標記已讀
                        await fetch('/api/user/gamification/events/seen', { method: 'POST' });
                    } catch (e) {
                        /* silently ignore event loading failures */
                    }
                }
            };
        }
    </script>
</div>
</html>
