<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-Hant">
<head th:replace="~{fragments/head :: head('BtcTrade - 冒險設定')}"></head>
<body class="bg-bg-dark text-text-main min-h-screen">

<div th:replace="~{fragments/navbar :: navbar(${user})}"></div>
<div th:replace="~{fragments/pixel-overlay :: pixelOverlay}"></div>

<main class="pt-[60px] px-4 md:px-6 pb-12 max-w-4xl mx-auto" x-data="settingsApp()"
      th:data-user-id="${user.id}" th:data-nickname="${user.nickname}"
      th:data-id-tag="${user.idTag}" th:data-avatar-url="${user.effectiveAvatarUrl}"
      th:data-has-custom-avatar="${user.customAvatarData != null}">

    <div class="mb-6">
        <h1 class="font-heading text-lg text-primary glow-gold">&#9881; 冒險設定</h1>
        <p class="text-text-muted text-[13px] mt-1">管理通知管道與角色職業</p>
    </div>

    <!-- 像素 Tab 導航 -->
    <div class="flex gap-1 mb-4 flex-wrap" role="tablist" aria-label="設定分頁">
        <button @click="activeTab = 'profile'" role="tab" :aria-selected="activeTab === 'profile'"
                :class="activeTab === 'profile' ? 'pixel-btn-gold' : 'pixel-btn-purple opacity-60'"
                class="pixel-btn text-[13px] py-1.5 px-3 cursor-pointer">&#128100; 個人資訊</button>
        <button @click="activeTab = 'character'" role="tab" :aria-selected="activeTab === 'character'"
                :class="activeTab === 'character' ? 'pixel-btn-gold' : 'pixel-btn-purple opacity-60'"
                class="pixel-btn text-[13px] py-1.5 px-3 cursor-pointer">&#9876; 角色</button>
        <button @click="activeTab = 'discord'" role="tab" :aria-selected="activeTab === 'discord'"
                :class="activeTab === 'discord' ? 'pixel-btn-gold' : 'pixel-btn-purple opacity-60'"
                class="pixel-btn text-[13px] py-1.5 px-3 cursor-pointer">&#128172; Discord</button>
        <button @click="activeTab = 'gmail'" role="tab" :aria-selected="activeTab === 'gmail'"
                :class="activeTab === 'gmail' ? 'pixel-btn-gold' : 'pixel-btn-purple opacity-60'"
                class="pixel-btn text-[13px] py-1.5 px-3 cursor-pointer">&#9993; Gmail</button>
        <button @click="activeTab = 'telegram'" role="tab" :aria-selected="activeTab === 'telegram'"
                :class="activeTab === 'telegram' ? 'pixel-btn-gold' : 'pixel-btn-purple opacity-60'"
                class="pixel-btn text-[13px] py-1.5 px-3 cursor-pointer">&#9992; Telegram</button>
    </div>

    <!-- 個人資訊設定 -->
    <div x-show="activeTab === 'profile'" x-cloak>
        <div class="grid md:grid-cols-2 gap-4">
            <!-- 頭像設定 -->
            <div class="pixel-card p-4">
                <h2 class="text-sm text-text-heading mb-3">&#128247; 頭像設定</h2>
                <div class="flex items-center gap-4 mb-4">
                    <template x-if="avatarPreview || currentAvatarUrl">
                        <img :src="avatarPreview || currentAvatarUrl" class="w-16 h-16 border-2 border-primary" style="image-rendering: pixelated;" alt="avatar">
                    </template>
                    <template x-if="!avatarPreview && !currentAvatarUrl">
                        <div class="w-16 h-16 bg-primary/20 flex items-center justify-center text-primary text-2xl font-heading border-2 border-primary">?</div>
                    </template>
                    <div>
                        <div class="text-xs text-text-heading" x-text="nickname + '#' + idTag"></div>
                        <div class="text-[10px] text-text-muted mt-1">128x128 / PNG</div>
                    </div>
                </div>
                <div class="space-y-2">
                    <label class="block">
                        <span class="text-xs text-text-muted">上傳自訂頭像（10MB 以下）</span>
                        <input type="file" accept="image/*" @change="previewAvatar($event)"
                               class="block w-full text-xs text-text-muted mt-1 file:mr-2 file:py-1 file:px-3 file:text-[10px] file:pixel-btn file:pixel-btn-purple file:cursor-pointer file:border-0">
                    </label>
                    <div class="flex gap-2">
                        <button @click="uploadAvatar()" :disabled="!avatarFile || uploadingAvatar"
                                class="pixel-btn pixel-btn-gold text-[11px] py-1 px-3 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed">
                            <span x-show="!uploadingAvatar">&#10003; 上傳</span>
                            <span x-show="uploadingAvatar" class="anim-flash">上傳中...</span>
                        </button>
                        <button @click="deleteAvatar()" x-show="hasCustomAvatar"
                                class="pixel-btn pixel-btn-purple text-[11px] py-1 px-3 cursor-pointer">
                            &#10005; 移除頭像
                        </button>
                    </div>
                </div>
            </div>

            <!-- 暱稱設定 -->
            <div class="pixel-card p-4">
                <h2 class="text-sm text-text-heading mb-3">&#9997; 暱稱設定</h2>
                <p class="text-[11px] text-text-muted mb-4">你在排行榜和 PVP 中的顯示名稱（最多 20 字）</p>
                <div class="space-y-3">
                    <div>
                        <label class="block text-xs text-text-muted mb-1">暱稱</label>
                        <div class="flex gap-2">
                            <input type="text" x-model="nickname" maxlength="20" placeholder="輸入暱稱..."
                                   class="flex-1 px-2 py-1.5 bg-bg-input pixel-border-dark text-text-main text-[13px] focus:outline-none">
                            <span class="text-text-muted text-sm self-center">#<span x-text="idTag"></span></span>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button @click="saveNickname()" :disabled="savingNick"
                                class="pixel-btn pixel-btn-gold text-[11px] py-1 px-3 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed">
                            <span x-show="!savingNick">&#10003; 儲存</span>
                            <span x-show="savingNick" class="anim-flash">儲存中...</span>
                        </button>
                        <button @click="randomNickname()"
                                class="pixel-btn pixel-btn-purple text-[11px] py-1 px-3 cursor-pointer">
                            &#127922; 隨機
                        </button>
                    </div>
                </div>
                <div class="mt-4 pixel-card p-3 bg-bg-dark/50">
                    <div class="text-[10px] text-primary mb-1">&#128161; 預覽效果</div>
                    <div class="flex items-center gap-2">
                        <template x-if="avatarPreview || currentAvatarUrl">
                            <img :src="avatarPreview || currentAvatarUrl" class="w-6 h-6 border border-primary/30" style="image-rendering: pixelated;" alt="">
                        </template>
                        <template x-if="!avatarPreview && !currentAvatarUrl">
                            <div class="w-6 h-6 bg-primary/20 flex items-center justify-center text-primary text-[10px] font-heading border border-primary/30">?</div>
                        </template>
                        <span class="text-xs text-text-heading" x-text="nickname + '#' + idTag"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 角色設定 -->
    <div x-show="activeTab === 'character'" x-cloak>
        <div class="pixel-card p-4">
            <h2 class="text-sm text-text-heading mb-4">&#128100; 選擇職業</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                <template x-for="cls in classes" :key="cls.key">
                    <button @click="selectClass(cls.key)"
                            class="pixel-card p-3 text-center cursor-pointer transition-all duration-100"
                            :class="selectedClass === cls.key ? 'pixel-border ring-2 ring-primary' : 'hover:bg-white/5'">
                        <div class="flex justify-center mb-3">
                            <div class="relative w-[48px] h-[48px]">
                                <div class="absolute top-0 left-0 anim-idle" :class="'pixel-char-' + cls.key.toLowerCase()"></div>
                            </div>
                        </div>
                        <div class="text-[13px] font-heading" :class="selectedClass === cls.key ? 'text-primary' : 'text-text-heading'" x-text="cls.name"></div>
                        <div class="text-xs text-text-muted mt-1" x-text="cls.desc"></div>
                    </button>
                </template>
            </div>
            <div class="mt-4 flex justify-end">
                <button @click="saveClass()" :disabled="savingClass"
                        class="pixel-btn pixel-btn-gold text-[13px] py-1.5 px-4 disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer">
                    <span x-show="!savingClass">&#10003; 確認職業</span>
                    <span x-show="savingClass" class="anim-flash">儲存中...</span>
                </button>
            </div>
        </div>

        <!-- 成就列表 -->
        <div class="pixel-card p-4 mt-4">
            <h2 class="text-sm text-text-heading mb-3">&#127942; 成就列表</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                <template x-for="a in achievements" :key="a.key">
                    <div class="flex items-center gap-2 px-2 py-1.5 text-xs"
                         :class="a.unlocked ? 'text-text-main' : 'text-text-muted opacity-50'">
                        <span x-text="a.unlocked ? '&#9733;' : '&#9734;'" :class="a.unlocked ? 'text-primary' : ''"></span>
                        <div>
                            <span class="font-heading" x-text="a.name"></span>
                            <span class="text-text-muted ml-1" x-text="'— ' + a.desc"></span>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <!-- Discord 設定 -->
    <div x-show="activeTab === 'discord'" x-cloak>
        <div class="pixel-card p-4">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h2 class="text-sm text-text-heading">&#128172; Discord 通知</h2>
                    <p class="text-text-muted text-xs mt-0.5">使用 Discord Webhook 發送交易訊號</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" x-model="discord.enabled" class="sr-only peer">
                    <div class="w-10 h-5 bg-border-main pixel-border-dark peer peer-checked:bg-cta
                                after:content-[''] after:absolute after:top-[3px] after:left-[3px] after:bg-text-main
                                after:h-3.5 after:w-3.5 after:transition-all peer-checked:after:translate-x-[18px]"
                         style="image-rendering: pixelated;"></div>
                </label>
            </div>

            <div class="space-y-3">
                <div>
                    <label class="block text-xs text-text-muted mb-1">Webhook URL</label>
                    <input type="password" x-model="discord.webhookUrl" placeholder="https://discord.com/api/webhooks/..."
                           class="w-full px-2 py-1.5 bg-bg-input pixel-border-dark text-text-main text-[13px] focus:outline-none">
                    <p class="text-xs text-text-muted mt-0.5">伺服器設定 &#8594; 整合 &#8594; Webhook &#8594; 複製 URL</p>
                </div>
                <div class="flex gap-4 pt-1">
                    <label class="flex items-center gap-1.5 cursor-pointer text-xs">
                        <input type="checkbox" x-model="discord.notifyOnEntry" class="w-3 h-3 accent-cta">
                        <span>進場通知</span>
                    </label>
                    <label class="flex items-center gap-1.5 cursor-pointer text-xs">
                        <input type="checkbox" x-model="discord.notifyOnExit" class="w-3 h-3 accent-cta">
                        <span>出場通知</span>
                    </label>
                </div>
            </div>

            <div class="flex items-center justify-between mt-4 pt-3 border-t border-border-main">
                <button @click="testChannel('DISCORD')" :disabled="testing"
                        class="pixel-btn pixel-btn-purple text-xs py-1 px-3 disabled:opacity-50 cursor-pointer">
                    <span x-show="!testing">&#128225; 測試</span>
                    <span x-show="testing" class="anim-flash">測試中...</span>
                </button>
                <div class="flex gap-2">
                    <button x-show="discord.id" @click="deleteChannel('DISCORD')"
                            class="pixel-btn text-xs py-1 px-3 text-negative cursor-pointer" style="box-shadow: -2px 0 0 0 #ef4444, 2px 0 0 0 #ef4444, 0 -2px 0 0 #ef4444, 0 2px 0 0 #ef4444;">&#10005; 刪除</button>
                    <button @click="saveChannel('DISCORD')" :disabled="saving"
                            class="pixel-btn pixel-btn-gold text-xs py-1 px-3 disabled:opacity-50 cursor-pointer">
                        <span x-show="!saving">&#128190; 儲存</span>
                        <span x-show="saving" class="anim-flash">儲存中...</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Gmail 設定 -->
    <div x-show="activeTab === 'gmail'" x-cloak>
        <div class="pixel-card p-4">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h2 class="text-sm text-text-heading">&#9993; Gmail 通知</h2>
                    <p class="text-text-muted text-xs mt-0.5">系統 SMTP 發送郵件到指定信箱</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" x-model="gmail.enabled" class="sr-only peer">
                    <div class="w-10 h-5 bg-border-main pixel-border-dark peer peer-checked:bg-cta
                                after:content-[''] after:absolute after:top-[3px] after:left-[3px] after:bg-text-main
                                after:h-3.5 after:w-3.5 after:transition-all peer-checked:after:translate-x-[18px]"
                         style="image-rendering: pixelated;"></div>
                </label>
            </div>

            <div class="space-y-3">
                <div>
                    <label class="block text-xs text-text-muted mb-1">收件人 Email</label>
                    <input type="email" x-model="gmail.recipientEmail" placeholder="your-email@gmail.com"
                           class="w-full px-2 py-1.5 bg-bg-input pixel-border-dark text-text-main text-[13px] focus:outline-none">
                </div>
                <div class="flex gap-4 pt-1">
                    <label class="flex items-center gap-1.5 cursor-pointer text-xs">
                        <input type="checkbox" x-model="gmail.notifyOnEntry" class="w-3 h-3 accent-cta">
                        <span>進場通知</span>
                    </label>
                    <label class="flex items-center gap-1.5 cursor-pointer text-xs">
                        <input type="checkbox" x-model="gmail.notifyOnExit" class="w-3 h-3 accent-cta">
                        <span>出場通知</span>
                    </label>
                </div>
            </div>

            <div class="flex items-center justify-between mt-4 pt-3 border-t border-border-main">
                <button @click="testChannel('GMAIL')" :disabled="testing"
                        class="pixel-btn pixel-btn-purple text-xs py-1 px-3 disabled:opacity-50 cursor-pointer">
                    <span x-show="!testing">&#128225; 測試</span>
                    <span x-show="testing" class="anim-flash">測試中...</span>
                </button>
                <div class="flex gap-2">
                    <button x-show="gmail.id" @click="deleteChannel('GMAIL')"
                            class="pixel-btn text-xs py-1 px-3 text-negative cursor-pointer" style="box-shadow: -2px 0 0 0 #ef4444, 2px 0 0 0 #ef4444, 0 -2px 0 0 #ef4444, 0 2px 0 0 #ef4444;">&#10005; 刪除</button>
                    <button @click="saveChannel('GMAIL')" :disabled="saving"
                            class="pixel-btn pixel-btn-gold text-xs py-1 px-3 disabled:opacity-50 cursor-pointer">
                        <span x-show="!saving">&#128190; 儲存</span>
                        <span x-show="saving" class="anim-flash">儲存中...</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Telegram 設定 -->
    <div x-show="activeTab === 'telegram'" x-cloak>
        <div class="pixel-card p-4">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h2 class="text-sm text-text-heading">&#9992; Telegram 通知</h2>
                    <p class="text-text-muted text-xs mt-0.5">使用 Telegram Bot 發送訊號通知</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" x-model="telegram.enabled" class="sr-only peer">
                    <div class="w-10 h-5 bg-border-main pixel-border-dark peer peer-checked:bg-cta
                                after:content-[''] after:absolute after:top-[3px] after:left-[3px] after:bg-text-main
                                after:h-3.5 after:w-3.5 after:transition-all peer-checked:after:translate-x-[18px]"
                         style="image-rendering: pixelated;"></div>
                </label>
            </div>

            <div class="space-y-3">
                <div>
                    <label class="block text-xs text-text-muted mb-1">Bot Token</label>
                    <input type="password" x-model="telegram.botToken" placeholder="Telegram Bot Token"
                           class="w-full px-2 py-1.5 bg-bg-input pixel-border-dark text-text-main text-[13px] focus:outline-none">
                    <p class="text-xs text-text-muted mt-0.5">@BotFather 取得</p>
                </div>
                <div>
                    <label class="block text-xs text-text-muted mb-1">Chat ID</label>
                    <input type="text" x-model="telegram.chatId" placeholder="Chat ID"
                           class="w-full px-2 py-1.5 bg-bg-input pixel-border-dark text-text-main text-[13px] focus:outline-none">
                    <p class="text-xs text-text-muted mt-0.5">@userinfobot 取得</p>
                </div>
                <div class="flex gap-4 pt-1">
                    <label class="flex items-center gap-1.5 cursor-pointer text-xs">
                        <input type="checkbox" x-model="telegram.notifyOnEntry" class="w-3 h-3 accent-cta">
                        <span>進場通知</span>
                    </label>
                    <label class="flex items-center gap-1.5 cursor-pointer text-xs">
                        <input type="checkbox" x-model="telegram.notifyOnExit" class="w-3 h-3 accent-cta">
                        <span>出場通知</span>
                    </label>
                </div>
            </div>

            <div class="flex items-center justify-between mt-4 pt-3 border-t border-border-main">
                <button @click="testChannel('TELEGRAM')" :disabled="testing"
                        class="pixel-btn pixel-btn-purple text-xs py-1 px-3 disabled:opacity-50 cursor-pointer">
                    <span x-show="!testing">&#128225; 測試</span>
                    <span x-show="testing" class="anim-flash">測試中...</span>
                </button>
                <div class="flex gap-2">
                    <button x-show="telegram.id" @click="deleteChannel('TELEGRAM')"
                            class="pixel-btn text-xs py-1 px-3 text-negative cursor-pointer" style="box-shadow: -2px 0 0 0 #ef4444, 2px 0 0 0 #ef4444, 0 -2px 0 0 #ef4444, 0 2px 0 0 #ef4444;">&#10005; 刪除</button>
                    <button @click="saveChannel('TELEGRAM')" :disabled="saving"
                            class="pixel-btn pixel-btn-gold text-xs py-1 px-3 disabled:opacity-50 cursor-pointer">
                        <span x-show="!saving">&#128190; 儲存</span>
                        <span x-show="saving" class="anim-flash">儲存中...</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div x-show="message" x-cloak x-transition class="fixed bottom-4 right-4 pixel-card px-4 py-2 text-[13px] z-50"
         :class="messageType === 'success' ? 'text-positive' : 'text-negative'" x-text="message"></div>
</main>

<script>
    function settingsApp() {
        return {
            activeTab: 'profile',
            saving: false, savingClass: false, testing: false,
            message: '', messageType: 'success',
            selectedClass: 'WARRIOR',
            classes: [
                { key: 'WARRIOR', name: '戰士', desc: '攻守兼備的全能型' },
                { key: 'MAGE', name: '法師', desc: '高風險高報酬策略' },
                { key: 'RANGER', name: '遊俠', desc: '穩健的長線操作' },
                { key: 'ASSASSIN', name: '刺客', desc: '快進快出短線高手' }
            ],
            achievements: [],
            discord: { id: null, enabled: false, webhookUrl: '', notifyOnEntry: true, notifyOnExit: true },
            gmail: { id: null, enabled: false, recipientEmail: '', notifyOnEntry: true, notifyOnExit: true },
            telegram: { id: null, enabled: false, botToken: '', chatId: '', notifyOnEntry: true, notifyOnExit: true },
            // 個人資訊 / 暱稱
            nickname: '', idTag: '', currentAvatarUrl: '',
            avatarPreview: null, avatarFile: null, uploadingAvatar: false, hasCustomAvatar: false,
            savingNick: false,

            async init() {
                const el = this.$el;
                this.nickname = el.dataset.nickname || '';
                this.idTag = el.dataset.idTag || '0000';
                this.currentAvatarUrl = el.dataset.avatarUrl || '';
                this.hasCustomAvatar = el.dataset.hasCustomAvatar === 'true';
                await Promise.all([this.loadProfile(), this.loadChannels()]);
            },
            async loadProfile() {
                try {
                    const r = await fetch('/api/user/gamification/profile');
                    if (!r.ok) return;
                    const p = await r.json();
                    this.selectedClass = p.characterClass || 'WARRIOR';
                    const unlocked = new Set((p.achievements || []).map(a => a.key));
                    this.achievements = [
                        { key: 'FIRST_LOGIN', name: '初次冒險', desc: '首次登入', unlocked: unlocked.has('FIRST_LOGIN') },
                        { key: 'LOGIN_7D', name: '七日連續', desc: '累計7天登入', unlocked: unlocked.has('LOGIN_7D') },
                        { key: 'LOGIN_30D', name: '月光旅人', desc: '累計30天登入', unlocked: unlocked.has('LOGIN_30D') },
                        { key: 'LOGIN_100D', name: '百日征途', desc: '累計100天登入', unlocked: unlocked.has('LOGIN_100D') },
                        { key: 'FIRST_BACKTEST', name: '初次回測', desc: '完成首次回測', unlocked: unlocked.has('FIRST_BACKTEST') },
                        { key: 'PROFITABLE_1', name: '初嚐勝果', desc: '首次獲利回測', unlocked: unlocked.has('PROFITABLE_1') },
                        { key: 'PROFITABLE_10', name: '連戰連勝', desc: '10次獲利回測', unlocked: unlocked.has('PROFITABLE_10') },
                        { key: 'STRATEGY_CLONE', name: '策略複製師', desc: '首次克隆策略', unlocked: unlocked.has('STRATEGY_CLONE') },
                        { key: 'STRATEGY_5', name: '策略大師', desc: '擁有5個策略', unlocked: unlocked.has('STRATEGY_5') },
                        { key: 'WATCHLIST_5', name: '觀察者', desc: '觀察5個幣對', unlocked: unlocked.has('WATCHLIST_5') },
                        { key: 'LEVEL_5', name: '銅級交易員', desc: '達到 Lv.5', unlocked: unlocked.has('LEVEL_5') },
                        { key: 'LEVEL_10', name: '銀級交易員', desc: '達到 Lv.10', unlocked: unlocked.has('LEVEL_10') },
                        { key: 'LEVEL_25', name: '金級交易員', desc: '達到 Lv.25', unlocked: unlocked.has('LEVEL_25') },
                        { key: 'LEVEL_50', name: '傳說交易員', desc: '達到 Lv.50', unlocked: unlocked.has('LEVEL_50') },
                        { key: 'SHARPE_1', name: '風險大師', desc: 'Sharpe > 1.0', unlocked: unlocked.has('SHARPE_1') },
                        { key: 'ANNUAL_30', name: '年化30%+', desc: '年化報酬 > 30%', unlocked: unlocked.has('ANNUAL_30') }
                    ];
                } catch (e) {}
            },
            async loadChannels() {
                try {
                    const r = await fetch('/api/user/notifications');
                    if (!r.ok) return;
                    (await r.json()).forEach(ch => {
                        let cfg = {};
                        try { cfg = JSON.parse(ch.configJson || '{}'); } catch(_) { cfg = {}; }
                        if (ch.channelType === 'DISCORD') this.discord = { id: ch.id, enabled: ch.enabled, webhookUrl: cfg.webhookUrl||'', notifyOnEntry: ch.notifyOnEntry, notifyOnExit: ch.notifyOnExit };
                        else if (ch.channelType === 'GMAIL') this.gmail = { id: ch.id, enabled: ch.enabled, recipientEmail: cfg.recipientEmail||'', notifyOnEntry: ch.notifyOnEntry, notifyOnExit: ch.notifyOnExit };
                        else if (ch.channelType === 'TELEGRAM') this.telegram = { id: ch.id, enabled: ch.enabled, botToken: cfg.botToken||'', chatId: cfg.chatId||'', notifyOnEntry: ch.notifyOnEntry, notifyOnExit: ch.notifyOnExit };
                    });
                } catch (e) {}
            },
            selectClass(key) { this.selectedClass = key; },
            async saveClass() {
                this.savingClass = true;
                try {
                    const r = await fetch('/api/user/gamification/character-class', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({characterClass: this.selectedClass}) });
                    if (r.ok) this.showMsg('職業已更新（活躍策略已同步切換）', 'success');
                    else { const e = await r.json(); this.showMsg(e.error||'更新失敗', 'error'); }
                } catch (e) { this.showMsg('網路錯誤', 'error'); }
                finally { this.savingClass = false; }
            },
            async saveChannel(type) {
                this.saving = true;
                try {
                    const data = this.buildPayload(type);
                    if (!data) return;
                    const r = await fetch('/api/user/notifications', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(data) });
                    if (r.ok) {
                        const res = await r.json();
                        if (type==='DISCORD') this.discord.id=res.id;
                        else if (type==='GMAIL') this.gmail.id=res.id;
                        else if (type==='TELEGRAM') this.telegram.id=res.id;
                        this.showMsg('設定已儲存', 'success');
                    } else { const e = await r.json(); this.showMsg(e.error||'儲存失敗', 'error'); }
                } catch (e) { this.showMsg('網路錯誤', 'error'); }
                finally { this.saving = false; }
            },
            async testChannel(type) {
                const cid = type==='DISCORD'?this.discord.id:type==='GMAIL'?this.gmail.id:this.telegram.id;
                if (!cid) { this.showMsg('請先儲存設定', 'error'); return; }
                this.testing = true;
                try {
                    const r = await fetch(`/api/user/notifications/${cid}/test`, { method: 'POST' });
                    if (r.ok) { const res = await r.json(); this.showMsg(res.success?'測試訊息已發送':'測試失敗', res.success?'success':'error'); }
                    else this.showMsg('測試失敗', 'error');
                } catch (e) { this.showMsg('網路錯誤', 'error'); }
                finally { this.testing = false; }
            },
            async deleteChannel(type) {
                const cid = type==='DISCORD'?this.discord.id:type==='GMAIL'?this.gmail.id:this.telegram.id;
                if (!cid || !await pixelConfirm('\u78BA\u5B9A\u522A\u9664\u6B64\u901A\u77E5\u7BA1\u9053\uFF1F')) return;
                try {
                    const r = await fetch(`/api/user/notifications/${cid}`, { method: 'DELETE' });
                    if (r.ok) {
                        if (type==='DISCORD') this.discord={id:null,enabled:false,webhookUrl:'',notifyOnEntry:true,notifyOnExit:true};
                        else if (type==='GMAIL') this.gmail={id:null,enabled:false,recipientEmail:'',notifyOnEntry:true,notifyOnExit:true};
                        else this.telegram={id:null,enabled:false,botToken:'',chatId:'',notifyOnEntry:true,notifyOnExit:true};
                        this.showMsg('已刪除', 'success');
                    }
                } catch (e) { this.showMsg('刪除失敗', 'error'); }
            },
            buildPayload(type) {
                let cfg, form;
                if (type==='DISCORD') { form=this.discord; cfg=JSON.stringify({webhookUrl:form.webhookUrl}); }
                else if (type==='GMAIL') { form=this.gmail; cfg=JSON.stringify({recipientEmail:form.recipientEmail}); }
                else if (type==='TELEGRAM') { form=this.telegram; cfg=JSON.stringify({botToken:form.botToken,chatId:form.chatId}); }
                else return null;
                return { channelType:type, configJson:cfg, enabled:form.enabled, notifyOnEntry:form.notifyOnEntry, notifyOnExit:form.notifyOnExit };
            },
            // ===== 暱稱 =====
            async saveNickname() {
                if (!this.nickname.trim()) { this.showMsg('暱稱不能為空', 'error'); return; }
                this.savingNick = true;
                try {
                    const r = await fetch('/api/user/nickname', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({nickname: this.nickname.trim()}) });
                    const res = await r.json();
                    if (res.success) this.showMsg('暱稱已更新', 'success');
                    else this.showMsg(res.error || '更新失敗', 'error');
                } catch (e) { this.showMsg('網路錯誤', 'error'); }
                finally { this.savingNick = false; }
            },
            randomNickname() {
                const adj = ['小','大','快','勇','智','蒼','金','銀','紅','藍','暗','光','火','冰','雷','星','月','風','雲','鐵'];
                const noun = ['天兵','勇者','法師','戰士','刺客','遊俠','騎士','旅人','冒險者','學徒','獵人','弓手','術士','劍客','守衛'];
                this.nickname = adj[Math.floor(Math.random()*adj.length)] + noun[Math.floor(Math.random()*noun.length)];
            },
            // ===== 頭像 =====
            previewAvatar(event) {
                const file = event.target.files[0];
                if (!file) { this.avatarFile = null; this.avatarPreview = null; return; }
                if (file.size > 10 * 1024 * 1024) { this.showMsg('檔案大小超過 10MB', 'error'); event.target.value = ''; return; }
                if (!file.type.startsWith('image/')) { this.showMsg('僅支援圖片檔案', 'error'); event.target.value = ''; return; }
                this.avatarFile = file;
                const reader = new FileReader();
                reader.onload = (e) => { this.avatarPreview = e.target.result; };
                reader.readAsDataURL(file);
            },
            async uploadAvatar() {
                if (!this.avatarFile) return;
                this.uploadingAvatar = true;
                try {
                    const fd = new FormData();
                    fd.append('file', this.avatarFile);
                    const r = await fetch('/api/user/avatar/upload', { method: 'POST', body: fd });
                    const res = await r.json();
                    if (res.success) {
                        this.currentAvatarUrl = res.avatarUrl;
                        this.hasCustomAvatar = true;
                        this.avatarPreview = null;
                        this.avatarFile = null;
                        this.showMsg('頭像已更新', 'success');
                    } else { this.showMsg(res.error || '上傳失敗', 'error'); }
                } catch (e) { this.showMsg('網路錯誤', 'error'); }
                finally { this.uploadingAvatar = false; }
            },
            async deleteAvatar() {
                try {
                    const r = await fetch('/api/user/avatar', { method: 'DELETE' });
                    if (r.ok) {
                        this.hasCustomAvatar = false;
                        this.currentAvatarUrl = '';
                        this.avatarPreview = null;
                        this.showMsg('頭像已移除', 'success');
                    } else this.showMsg('刪除失敗', 'error');
                } catch (e) { this.showMsg('網路錯誤', 'error'); }
            },
            showMsg(m,t) { this.message=m; this.messageType=t; setTimeout(()=>{this.message='';},3000); }
        };
    }
</script>
</body>
</html>
