<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-TW">
<head th:replace="~{fragments/head :: head('BtcTrade Dashboard')}"></head>
<body class="bg-bg-dark text-text-main font-body min-h-screen">
    <!-- Navbar -->
    <div th:replace="~{fragments/navbar :: navbar(${user})}"></div>

    <!-- Sidebar -->
    <div th:replace="~{fragments/sidebar :: sidebar(${symbols}, ${allSymbols}, ${userSymbols}, ${activeSymbol})}"></div>

    <!-- Main Content -->
    <main class="md:ml-64 pt-[57px] p-4 md:p-6">
        <!-- Page Header -->
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-4">
                <h1 class="font-heading text-2xl font-bold text-primary glow-gold" th:text="${activeSymbol}">BTCUSDT</h1>
                <div class="flex items-center gap-2">
                    <span id="ws-status" class="w-2.5 h-2.5 rounded-full bg-negative transition-colors duration-300"></span>
                    <span class="text-xs text-text-muted" id="ws-label">未連線</span>
                </div>
            </div>
            <div class="text-sm text-text-muted">
                <span th:text="'歡迎, ' + ${user.displayName}">歡迎</span>
            </div>
        </div>

        <!-- DELISTED 警告橫幅 -->
        <div th:if="${activeSymbolDelisted}" id="delist-banner"
             class="mb-6 bg-negative/10 border border-negative/30 rounded-xl p-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <svg class="w-6 h-6 text-negative flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
                <div>
                    <span class="text-negative font-semibold text-sm">已查無此幣別</span>
                    <span class="text-text-muted text-xs ml-2" th:text="'幣對 ' + ${activeSymbol} + ' 已從 Binance 下架，資料停止更新'">-</span>
                </div>
            </div>
            <button onclick="reenableCurrentSymbol()"
                    class="px-4 py-2 text-sm font-medium text-warning bg-warning/10 border border-warning/30 rounded-lg hover:bg-warning/20 transition-colors duration-200 cursor-pointer flex-shrink-0">
                重新啟用
            </button>
        </div>

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <!-- 當前幣對 -->
            <div class="bg-bg-card border border-border-main rounded-xl p-5">
                <div class="text-xs text-text-muted uppercase tracking-wider mb-2">當前幣對</div>
                <div class="font-heading text-2xl font-bold text-primary glow-gold" th:text="${activeSymbol}">BTCUSDT</div>
            </div>
            <!-- K 線資料 -->
            <div class="bg-bg-card border border-border-main rounded-xl p-5">
                <div class="text-xs text-text-muted uppercase tracking-wider mb-2">K 線資料筆數</div>
                <div class="font-heading text-2xl font-bold text-text-main" th:text="${#numbers.formatInteger(klineCount, 1, 'COMMA')}">0</div>
            </div>
            <!-- 交易筆數 -->
            <div class="bg-bg-card border border-border-main rounded-xl p-5">
                <div class="text-xs text-text-muted uppercase tracking-wider mb-2">歷史交易筆數</div>
                <div class="font-heading text-2xl font-bold text-text-main" th:text="${livePositions != null ? livePositions.size() : 0}">0</div>
            </div>
            <!-- 持倉狀態 -->
            <div class="bg-bg-card border border-border-main rounded-xl p-5">
                <div class="text-xs text-text-muted uppercase tracking-wider mb-2">持倉狀態</div>
                <div th:if="${openPosition != null}">
                    <span class="inline-block px-2.5 py-1 rounded-full text-xs font-bold"
                          th:classappend="${openPosition.direction.name() == 'LONG'} ? 'bg-positive/20 text-positive' : 'bg-negative/20 text-negative'"
                          th:text="${openPosition.direction.name()}">LONG</span>
                    <div class="text-xs text-text-muted mt-1" th:text="'Entry: $' + ${#numbers.formatDecimal(openPosition.entryPrice, 1, 'COMMA', 2, 'POINT')}">-</div>
                </div>
                <div th:unless="${openPosition != null}" class="font-heading text-2xl font-bold text-text-muted">--</div>
            </div>
        </div>

        <!-- Signal Log -->
        <div class="mb-6">
            <h2 class="text-xs font-bold text-text-muted uppercase tracking-wider mb-3">即時訊號</h2>
            <div class="bg-bg-card border border-border-main rounded-xl p-4">
                <div id="signal-log" class="max-h-48 overflow-y-auto scrollbar-thin font-mono text-sm text-text-muted leading-relaxed">
                    等待 WebSocket 連線...
                </div>
            </div>
        </div>

        <!-- Trade History -->
        <div>
            <h2 class="text-xs font-bold text-text-muted uppercase tracking-wider mb-3">交易紀錄</h2>
            <div class="bg-bg-card border border-border-main rounded-xl overflow-hidden overflow-x-auto scrollbar-thin">
                <table class="w-full min-w-[640px]">
                    <thead>
                        <tr class="border-b border-border-main">
                            <th class="px-4 py-3 text-left text-xs font-bold text-text-muted uppercase tracking-wider">方向</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-text-muted uppercase tracking-wider">進場價</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-text-muted uppercase tracking-wider">出場價</th>
                            <th class="px-4 py-3 text-right text-xs font-bold text-text-muted uppercase tracking-wider">損益</th>
                            <th class="px-4 py-3 text-right text-xs font-bold text-text-muted uppercase tracking-wider">報酬率</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-text-muted uppercase tracking-wider">原因</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-text-muted uppercase tracking-wider">狀態</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="pos : ${livePositions}" class="border-b border-border-main/50 hover:bg-white/[0.02] transition-colors duration-150">
                            <td class="px-4 py-3">
                                <span class="inline-block px-2 py-0.5 rounded-full text-xs font-bold"
                                      th:classappend="${pos.direction.name() == 'LONG'} ? 'bg-positive/20 text-positive' : 'bg-negative/20 text-negative'"
                                      th:text="${pos.direction.name()}">LONG</span>
                            </td>
                            <td class="px-4 py-3 font-mono text-sm" th:text="'$' + ${#numbers.formatDecimal(pos.entryPrice, 1, 'COMMA', 2, 'POINT')}">-</td>
                            <td class="px-4 py-3 font-mono text-sm" th:text="${pos.exitPrice != null ? '$' + #numbers.formatDecimal(pos.exitPrice, 1, 'COMMA', 2, 'POINT') : '--'}">-</td>
                            <td class="px-4 py-3 text-right font-mono text-sm font-semibold"
                                th:classappend="${pos.realizedPnl != null and pos.realizedPnl > 0} ? 'text-positive' : 'text-negative'"
                                th:text="${pos.realizedPnl != null ? (pos.realizedPnl > 0 ? '+' : '') + pos.realizedPnl : '--'}">-</td>
                            <td class="px-4 py-3 text-right font-mono text-sm font-semibold"
                                th:classappend="${pos.returnPct != null and pos.returnPct > 0} ? 'text-positive' : 'text-negative'"
                                th:text="${pos.returnPct != null ? (pos.returnPct > 0 ? '+' : '') + pos.returnPct.movePointRight(2) + '%' : '--'}">-</td>
                            <td class="px-4 py-3 text-sm text-text-muted" th:text="${pos.exitReason != null ? pos.exitReason : '--'}">-</td>
                            <td class="px-4 py-3">
                                <span class="inline-block px-2 py-0.5 rounded-full text-xs font-medium"
                                      th:classappend="${pos.status.name() == 'OPEN'} ? 'bg-primary/20 text-primary' : 'bg-white/10 text-text-muted'"
                                      th:text="${pos.status.name()}">-</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div th:if="${livePositions == null or livePositions.isEmpty()}" class="text-center py-12 text-text-muted text-sm">
                    暫無交易紀錄
                </div>
            </div>
        </div>
    </main>

    <!-- WebSocket Script -->
    <script th:inline="javascript">
        const activeSymbol = /*[[${activeSymbol}]]*/ 'BTCUSDT';
        const wsStatusEl = document.getElementById('ws-status');
        const wsLabel = document.getElementById('ws-label');
        const signalLog = document.getElementById('signal-log');
        let ws;

        function connectWs() {
            const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(protocol + '//' + location.host + '/ws/trades');

            ws.onopen = () => {
                wsStatusEl.classList.remove('bg-negative');
                wsStatusEl.classList.add('bg-positive');
                wsLabel.textContent = '已連線';
                wsLabel.classList.remove('text-negative');
                wsLabel.classList.add('text-positive');
                signalLog.textContent = '已連線，等待交易訊號...\n';
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                switch (data.type) {
                    case 'TRADE_SIGNAL': {
                        const time = new Date(data.timestamp).toLocaleTimeString();
                        const actionClass = data.action.includes('ENTRY') ? 'text-positive' : 'text-negative';
                        const line = document.createElement('div');
                        line.innerHTML = `<span class="text-text-muted">[${time}]</span> <span class="${actionClass} font-semibold">${data.action}</span> @ <span class="text-primary">$${Number(data.price).toLocaleString()}</span> <span class="text-text-muted">(RSI: ${Number(data.rsi).toFixed(1)})</span>`;
                        signalLog.appendChild(line);
                        signalLog.scrollTop = signalLog.scrollHeight;
                        break;
                    }
                    case 'PRICE_TICK': {
                        const priceEl = document.getElementById('price-' + data.symbol);
                        if (priceEl) {
                            priceEl.textContent = '$' + Number(data.price).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                        }
                        break;
                    }
                    case 'SYNC_PROGRESS': {
                        if (data.status === 'READY' || data.status === 'ERROR') {
                            location.reload();
                        }
                        break;
                    }
                    case 'SYMBOL_DELISTED': {
                        if (data.symbol === activeSymbol) {
                            location.reload();
                        }
                        break;
                    }
                }
            };

            ws.onclose = () => {
                wsStatusEl.classList.remove('bg-positive');
                wsStatusEl.classList.add('bg-negative');
                wsLabel.textContent = '已斷線';
                wsLabel.classList.remove('text-positive');
                wsLabel.classList.add('text-negative');
                setTimeout(connectWs, 5000);
            };
        }

        connectWs();

        async function reenableCurrentSymbol() {
            try {
                const resp = await fetch('/api/symbols/' + activeSymbol + '/reenable', { method: 'POST' });
                if (resp.ok) {
                    location.reload();
                } else {
                    const err = await resp.json();
                    toast(err.error || '重新啟用失敗', 'error');
                }
            } catch (e) {
                toast('網路連線異常，請稍後再試', 'error');
            }
        }
    </script>
</body>
</html>
