<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-TW">
<head th:replace="~{fragments/head :: head('BtcTrade - 冒險主控台')}"></head>
<body class="bg-bg-dark text-text-main min-h-screen">
    <!-- Navbar -->
    <div th:replace="~{fragments/navbar :: navbar(${user})}"></div>

    <!-- Sidebar -->
    <div th:replace="~{fragments/sidebar :: sidebar(${symbols}, ${allSymbols}, ${userSymbols}, ${activeSymbol})}"></div>

    <!-- 事件覆蓋層 -->
    <div th:replace="~{fragments/pixel-overlay :: pixelOverlay}"></div>

    <!-- Main Content -->
    <main class="md:ml-56 pt-[49px] p-3 md:p-5">
        <!-- 角色狀態欄 -->
        <div class="pixel-card p-4 mb-4" x-data="characterBar()" x-init="load()">
            <div class="flex items-center justify-between flex-wrap gap-3">
                <div class="flex items-center gap-3">
                    <!-- 像素角色 -->
                    <div class="relative w-12 h-12 shrink-0">
                        <div :class="'pixel-char-' + charClass.toLowerCase()"></div>
                    </div>
                    <div>
                        <div class="flex items-center gap-2">
                            <span class="font-heading text-sm text-primary glow-gold" x-text="'Lv.' + level"></span>
                            <span class="text-[13px] text-text-heading truncate max-w-[120px] md:max-w-[200px]" th:text="${user.displayName}" th:title="${user.displayName}">勇者</span>
                            <span class="text-xs px-1.5 py-0.5 pixel-border text-[13px] shrink-0" x-text="charLabel"></span>
                        </div>
                        <!-- EXP 條 -->
                        <div class="flex items-center gap-2 mt-1">
                            <span class="text-xs text-text-muted">EXP</span>
                            <div class="pixel-exp-bar w-32 md:w-48">
                                <div class="pixel-exp-fill" :style="'width:' + expPct + '%'"></div>
                            </div>
                            <span class="text-xs text-text-muted" x-text="currentExp + '/' + expToNext"></span>
                        </div>
                    </div>
                </div>
                <!-- 每日獎勵按鈕 -->
                <button @click="claimDaily()"
                        class="pixel-btn text-[13px] py-1.5 px-3"
                        :class="dailyClaimed ? 'pixel-btn-purple opacity-50 cursor-not-allowed' : 'pixel-btn-gold anim-sparkle'"
                        :disabled="dailyClaimed"
                        :aria-label="dailyClaimed ? '每日獎勵已領取' : '領取每日獎勵'">
                    <span x-text="dailyClaimed ? '&#10003; 已領取' : '&#128230; 每日獎勵'"></span>
                </button>
            </div>
        </div>

        <!-- 頁面標題 -->
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
                <h1 class="font-heading text-lg text-primary glow-gold" th:text="${activeSymbol}">BTCUSDT</h1>
                <div class="flex items-center gap-1">
                    <span id="ws-status" class="text-negative text-[13px]">&#9679;</span>
                    <span class="text-xs text-text-muted" id="ws-label">未連線</span>
                </div>
            </div>
        </div>

        <!-- 下架警告 -->
        <div th:if="${activeSymbolDelisted}" id="delist-banner"
             class="mb-4 pixel-card p-3 border-l-4 border-l-negative">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <span class="text-lg">&#9888;</span>
                    <div>
                        <span class="text-negative text-[13px]">已查無此幣別</span>
                        <span class="text-text-muted text-xs ml-1" th:text="'幣對 ' + ${activeSymbol} + ' 已從 Binance 下架'">-</span>
                    </div>
                </div>
                <button onclick="reenableCurrentSymbol()" class="pixel-btn pixel-btn-gold text-xs py-1 px-2">重新啟用</button>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-2 md:gap-3 mb-4">
            <div class="pixel-card p-3">
                <div class="text-xs text-text-muted mb-1">&#127902; 當前幣對</div>
                <div class="font-heading text-sm text-primary glow-gold" th:text="${activeSymbol}">BTCUSDT</div>
            </div>
            <div class="pixel-card p-3">
                <div class="text-xs text-text-muted mb-1">&#128202; K 線資料</div>
                <div class="font-heading text-base text-text-main"><span th:text="${#numbers.formatInteger(klineCount, 1, 'COMMA')}">0</span><span class="text-xs text-text-muted ml-1">筆</span></div>
            </div>
            <div class="pixel-card p-3">
                <div class="text-xs text-text-muted mb-1">&#9876; 歷史交易</div>
                <div class="font-heading text-base text-text-main" th:text="${livePositions != null ? livePositions.size() : 0}">0</div>
            </div>
            <div class="pixel-card p-3">
                <div class="text-xs text-text-muted mb-1">&#127919; 持倉狀態</div>
                <div th:if="${openPosition != null}">
                    <span class="text-[13px] font-heading"
                          th:classappend="${openPosition.direction.name() == 'LONG'} ? 'text-positive' : 'text-negative'"
                          th:text="${openPosition.direction.name() == 'LONG'} ? '做多' : '做空'">做多</span>
                </div>
                <div th:unless="${openPosition != null}" class="font-heading text-base text-text-muted">--</div>
            </div>
        </div>

        <!-- 戰鬥日誌（訊號） -->
        <div class="mb-4">
            <h2 class="text-sm text-primary font-heading mb-2">&#128220; 戰鬥日誌</h2>
            <div class="pixel-card p-3">
                <div id="signal-log" role="log" aria-live="polite" aria-label="交易訊號日誌"
                     class="max-h-40 overflow-y-auto scrollbar-thin text-[13px] text-text-muted leading-relaxed">
                    等待 WebSocket 連線...
                </div>
            </div>
        </div>

        <!-- 交易紀錄 -->
        <div>
            <h2 class="text-sm text-primary font-heading mb-2">&#128176; 交易紀錄</h2>
            <div class="pixel-card overflow-hidden overflow-x-auto scrollbar-thin">
                <table class="w-full min-w-[700px]" aria-label="交易紀錄">
                    <thead>
                        <tr class="border-b border-border-main">
                            <th scope="col" class="px-3 py-2 text-left text-xs text-text-muted">方向</th>
                            <th scope="col" class="px-3 py-2 text-left text-xs text-text-muted">進場時間</th>
                            <th scope="col" class="px-3 py-2 text-right text-xs text-text-muted">進場價</th>
                            <th scope="col" class="px-3 py-2 text-left text-xs text-text-muted">出場時間</th>
                            <th scope="col" class="px-3 py-2 text-right text-xs text-text-muted">出場價</th>
                            <th scope="col" class="px-3 py-2 text-right text-xs text-text-muted">報酬率</th>
                            <th scope="col" class="px-3 py-2 text-left text-xs text-text-muted">原因</th>
                            <th scope="col" class="px-3 py-2 text-left text-xs text-text-muted">狀態</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="pos : ${livePositions}" class="border-b border-border-main/50 hover:bg-white/[0.02]">
                            <td class="px-3 py-2">
                                <span class="text-[13px] font-heading"
                                      th:classappend="${pos.direction.name() == 'LONG'} ? 'text-positive' : 'text-negative'"
                                      th:text="${pos.direction.name() == 'LONG'} ? '做多' : '做空'">做多</span>
                            </td>
                            <td class="px-3 py-2 text-[13px] text-text-muted"
                                th:text="${T(java.time.LocalDateTime).ofInstant(pos.entryTime, T(java.time.ZoneId).of('Asia/Taipei')).format(T(java.time.format.DateTimeFormatter).ofPattern('MM/dd HH:mm'))}">-</td>
                            <td class="px-3 py-2 text-right text-[13px] text-text-main"
                                th:text="'$' + ${#numbers.formatDecimal(pos.entryPrice, 1, 'COMMA', 2, 'POINT')}">-</td>
                            <td class="px-3 py-2 text-[13px] text-text-muted"
                                th:text="${pos.exitTime != null ? T(java.time.LocalDateTime).ofInstant(pos.exitTime, T(java.time.ZoneId).of('Asia/Taipei')).format(T(java.time.format.DateTimeFormatter).ofPattern('MM/dd HH:mm')) : '--'}">-</td>
                            <td class="px-3 py-2 text-right text-[13px] text-text-main"
                                th:text="${pos.exitPrice != null ? '$' + #numbers.formatDecimal(pos.exitPrice, 1, 'COMMA', 2, 'POINT') : '--'}">-</td>
                            <td class="px-3 py-2 text-right text-[13px]"
                                th:classappend="${pos.returnPct != null and pos.returnPct > 0} ? 'text-positive' : 'text-negative'"
                                th:text="${pos.returnPct != null ? (pos.returnPct > 0 ? '+' : '') + #numbers.formatDecimal(pos.returnPct * 100, 1, 2) + '%' : '--'}">-</td>
                            <td class="px-3 py-2 text-[13px] text-text-muted"
                                th:text="${pos.exitReason == null ? '--' :
                                    pos.exitReason.name() == 'STOP_LOSS' ? '觸發停損' :
                                    pos.exitReason.name() == 'SIGNAL_REVERSAL' ? '策略反轉' :
                                    pos.exitReason.name() == 'RSI_EXTREME' ? 'RSI 極端值' :
                                    pos.exitReason.name() == 'MAX_HOLDING_PERIOD' ? '持倉到期' :
                                    pos.exitReason.name()}">-</td>
                            <td class="px-3 py-2">
                                <span class="text-xs"
                                      th:classappend="${pos.status.name() == 'OPEN'} ? 'text-primary' : 'text-text-muted'"
                                      th:text="${pos.status.name() == 'OPEN' ? '持倉中' : '已平倉'}">-</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div th:if="${livePositions == null or livePositions.isEmpty()}" class="text-center py-8">
                    <div class="text-2xl mb-2 opacity-40">&#128566;</div>
                    <div class="text-text-muted text-[13px]">尚無交易紀錄</div>
                    <div class="text-text-muted text-xs mt-2 leading-relaxed">
                        前往 <a href="/strategies" class="text-cta hover:text-cta-hover underline">策略</a> 頁面挑選策略，
                        再到 <a href="/backtest" class="text-cta hover:text-cta-hover underline">回測</a> 驗證效果
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script th:inline="javascript">
        const activeSymbol = /*[[${activeSymbol}]]*/ 'BTCUSDT';
        const wsStatusEl = document.getElementById('ws-status');
        const wsLabel = document.getElementById('ws-label');
        const signalLog = document.getElementById('signal-log');
        let ws;
        let wsRetryCount = 0;
        let wsCountdownId = null;

        const actionLabels = {
            'LONG_ENTRY': '做多進場', 'SHORT_ENTRY': '做空進場',
            'LONG_EXIT': '做多出場', 'SHORT_EXIT': '做空出場'
        };

        function connectWs() {
            const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(protocol + '//' + location.host + '/ws/trades');
            ws.onopen = () => {
                wsRetryCount = 0;
                if (wsCountdownId) { clearInterval(wsCountdownId); wsCountdownId = null; }
                wsStatusEl.textContent = '\u25CF';
                wsStatusEl.className = 'text-positive text-[13px]';
                wsLabel.textContent = '\u5DF2\u9023\u7DDA';
                signalLog.textContent = '\u5DF2\u9023\u7DDA\uFF0C\u7B49\u5F85\u6230\u9B25\u8A0A\u865F...\n';
            };
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    switch (data.type) {
                        case 'TRADE_SIGNAL': {
                            const time = new Date(data.timestamp).toLocaleTimeString();
                            const isEntry = String(data.action).includes('ENTRY');
                            const line = document.createElement('div');
                            const timeSpan = document.createElement('span');
                            timeSpan.className = 'text-text-muted';
                            timeSpan.textContent = '[' + time + '] ';
                            const actionSpan = document.createElement('span');
                            actionSpan.className = isEntry ? 'text-positive' : 'text-negative';
                            const label = actionLabels[String(data.action)] || String(data.action);
                            actionSpan.textContent = (isEntry ? '\u2694 ' : '\u{1F6E1} ') + label;
                            const priceSpan = document.createElement('span');
                            priceSpan.className = 'text-primary';
                            priceSpan.textContent = ' @ ' + Number(data.price).toLocaleString();
                            line.appendChild(timeSpan);
                            line.appendChild(actionSpan);
                            line.appendChild(priceSpan);
                            const nearBottom = signalLog.scrollHeight - signalLog.scrollTop - signalLog.clientHeight < 60;
                            if (signalLog.children.length > 100) signalLog.removeChild(signalLog.firstChild);
                            signalLog.appendChild(line);
                            if (nearBottom) signalLog.scrollTop = signalLog.scrollHeight;
                            break;
                        }
                        case 'PRICE_TICK': {
                            const priceEl = document.getElementById('price-' + String(data.symbol).replace(/[^A-Z0-9]/g, ''));
                            if (priceEl) {
                                priceEl.textContent = Number(data.price).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                                priceEl.classList.add('anim-flash');
                                setTimeout(() => priceEl.classList.remove('anim-flash'), 600);
                            }
                            break;
                        }
                        case 'SYNC_PROGRESS': { if (data.status === 'READY' || data.status === 'ERROR') location.reload(); break; }
                        case 'SYMBOL_DELISTED': { if (data.symbol === activeSymbol) location.reload(); break; }
                    }
                } catch (e) { /* ignore malformed WS messages */ }
            };
            ws.onclose = () => {
                wsRetryCount++;
                wsStatusEl.textContent = '\u25CF';
                wsStatusEl.className = 'text-warning text-[13px] anim-flash';
                const delay = Math.min(5000 * wsRetryCount, 30000);
                let remaining = Math.round(delay / 1000);
                wsLabel.textContent = '\u5DF2\u65B7\u7DDA\u2027' + remaining + 's\u5F8C\u91CD\u9023';
                if (wsCountdownId) clearInterval(wsCountdownId);
                wsCountdownId = setInterval(() => {
                    remaining--;
                    if (remaining > 0) {
                        wsLabel.textContent = '\u5DF2\u65B7\u7DDA\u2027' + remaining + 's\u5F8C\u91CD\u9023';
                    } else {
                        clearInterval(wsCountdownId);
                        wsCountdownId = null;
                    }
                }, 1000);
                setTimeout(() => { if (wsCountdownId) { clearInterval(wsCountdownId); wsCountdownId = null; } connectWs(); }, delay);
            };
        }
        connectWs();

        async function reenableCurrentSymbol() {
            try {
                const resp = await fetch('/api/symbols/' + activeSymbol + '/reenable', { method: 'POST' });
                if (resp.ok) location.reload();
                else { try { const err = await resp.json(); toast(err.error || '\u91CD\u65B0\u555F\u7528\u5931\u6557', 'error'); } catch(_) { toast('\u91CD\u65B0\u555F\u7528\u5931\u6557', 'error'); } }
            } catch (e) { toast('\u7DB2\u8DEF\u9023\u7DDA\u7570\u5E38', 'error'); }
        }

        function characterBar() {
            return {
                level: 1, currentExp: 0, expToNext: 50, expPct: 0, charClass: 'WARRIOR', dailyClaimed: false,
                charLabel: '戰士',
                classLabels: { WARRIOR: '戰士', MAGE: '法師', RANGER: '遊俠', ASSASSIN: '刺客' },
                async load() {
                    try {
                        const resp = await fetch('/api/user/gamification/profile');
                        if (!resp.ok) return;
                        const p = await resp.json();
                        this.level = p.level;
                        this.currentExp = p.currentExp;
                        this.expToNext = p.currentExp + p.expToNextLevel;
                        this.expPct = Math.min(100, p.expProgressPct);
                        this.charClass = p.characterClass || 'WARRIOR';
                        this.dailyClaimed = p.dailyRewardClaimed;
                        this.charLabel = this.classLabels[this.charClass] || this.charClass;
                    } catch (e) { /* 靜默 */ }
                },
                async claimDaily() {
                    if (this.dailyClaimed) return;
                    try {
                        const resp = await fetch('/api/user/gamification/daily', { method: 'POST' });
                        if (!resp.ok) return;
                        const result = await resp.json();
                        if (result.claimed) {
                            this.dailyClaimed = true;
                            toast(result.message, 'success');
                            await this.load();
                        } else {
                            toast(result.message, 'info');
                        }
                    } catch (e) { toast('領取失敗', 'error'); }
                }
            };
        }
    </script>
</body>
</html>
