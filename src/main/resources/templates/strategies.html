<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-Hant">
<head th:replace="~{fragments/head :: head('BtcTrade - 技能書')}"></head>
<body class="bg-bg-dark text-text-main min-h-screen">

<div th:replace="~{fragments/navbar :: navbar(${user})}"></div>
<div th:replace="~{fragments/pixel-overlay :: pixelOverlay}"></div>

<main class="pt-[60px] px-4 md:px-6 pb-12 max-w-7xl mx-auto" x-data="strategiesApp()">

    <!-- 頁面標題 -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="font-heading text-lg text-primary glow-gold">&#128214; 技能書</h1>
            <p class="text-text-muted text-[13px] mt-1">管理你的交易策略 — 克隆、調參、回測</p>
        </div>
    </div>

    <!-- 載入指示 -->
    <div x-show="loading" class="text-center py-8">
        <span class="text-sm text-primary anim-flash">&#9876; 載入中...</span>
    </div>

    <!-- 策略模板卡片 -->
    <div x-show="!loading" class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-6">
        <template x-for="tmpl in templates" :key="tmpl.id">
            <div class="pixel-card p-4" :class="tmpl.systemDefault ? 'border-l-4 border-l-primary' : ''">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-2">
                        <span class="text-sm" x-text="tmpl.systemDefault ? '&#9733;' : '&#128220;'"></span>
                        <h3 class="text-sm text-text-heading" x-text="tmpl.name"></h3>
                        <span x-show="tmpl.systemDefault" class="text-xs px-1.5 py-0.5 bg-primary/20 text-primary pixel-border">傳說</span>
                    </div>
                    <div class="flex gap-1">
                        <button @click="cloneTemplate(tmpl.id)" class="pixel-btn pixel-btn-purple text-xs py-0.5 px-2">複製卷軸</button>
                        <button x-show="!tmpl.systemDefault" @click="openEditor(tmpl)" class="pixel-btn pixel-btn-gold text-xs py-0.5 px-2">&#9998;</button>
                        <button x-show="!tmpl.systemDefault" @click="deleteTemplate(tmpl.id)"
                                class="text-[13px] text-negative hover:text-red-300 cursor-pointer px-1">&#10005;</button>
                    </div>
                </div>
                <div x-show="tmpl.systemDefault" class="text-xs text-text-muted mb-2 leading-relaxed bg-primary/5 px-2 py-1 pixel-border-dark">
                    &#128161; 系統預設策略不可直接編輯。請先點「複製卷軸」建立個人副本後再調整參數。
                </div>
                <div class="grid grid-cols-4 gap-2 text-xs">
                    <div class="bg-bg-input p-1.5 pixel-border-dark">
                        <span class="text-text-muted block">停損</span>
                        <span class="text-text-main" x-text="(tmpl.stopLossPct * 100).toFixed(1) + '%'"></span>
                    </div>
                    <div class="bg-bg-input p-1.5 pixel-border-dark">
                        <span class="text-text-muted block">移動停利</span>
                        <span class="text-text-main" x-text="(tmpl.trailingActivatePct * 100).toFixed(1) + '/' + (tmpl.trailingOffsetPct * 100).toFixed(1) + '%'"></span>
                    </div>
                    <div class="bg-bg-input p-1.5 pixel-border-dark">
                        <span class="text-text-muted block">倉位</span>
                        <span class="text-text-main" x-text="((tmpl.positionSizePct != null ? tmpl.positionSizePct : 1) * 100).toFixed(0) + '%'"></span>
                    </div>
                    <div class="bg-bg-input p-1.5 pixel-border-dark">
                        <span class="text-text-muted block">EMA</span>
                        <span class="text-text-main" x-text="tmpl.emaShort + '/' + tmpl.emaLong"></span>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <div x-show="templates.length === 0" class="text-center py-12">
        <div class="text-2xl mb-3 opacity-40">&#128214;</div>
        <p class="text-text-heading text-sm">歡迎踏上交易之旅！</p>
        <p class="text-text-muted text-[13px] mt-2 leading-relaxed">系統提供傳說級策略，複製後自訂參數即可開始回測</p>
        <div class="mt-4 text-xs text-text-muted leading-loose">
            <span class="block">1. 複製傳說級策略卷軸</span>
            <span class="block">2. 前往 <a href="/backtest" class="text-cta hover:text-cta-hover underline">副本挑戰</a> 調參回測</span>
            <span class="block">3. 至 <a href="/settings" class="text-cta hover:text-cta-hover underline">設定</a> 開啟交易通知</span>
        </div>
    </div>

    <!-- 績效對比 -->
    <div class="mb-6">
        <div class="flex items-center justify-between mb-3">
            <div>
                <h2 class="font-heading text-sm text-text-heading">&#128200; 績效對比</h2>
                <p class="text-text-muted text-xs mt-0.5">基準: BTCUSDT | 每 4 小時更新</p>
            </div>
            <div class="flex items-center gap-2">
                <span x-show="perfLoading" class="text-xs text-text-muted anim-flash">計算中...</span>
                <button @click="refreshAllPerformance()" :disabled="perfLoading"
                        class="pixel-btn pixel-btn-purple text-xs py-1 px-2 disabled:opacity-50">&#9889; 重新計算</button>
            </div>
        </div>

        <div class="flex gap-1 mb-2 flex-wrap" role="tablist" aria-label="績效指標切換">
            <template x-for="m in metricOptions" :key="m.key">
                <button @click="selectedMetric = m.key" role="tab"
                        :aria-selected="selectedMetric === m.key"
                        class="text-xs px-2 py-1 cursor-pointer transition-colors"
                        :class="selectedMetric === m.key ? 'pixel-border text-primary bg-primary/10' : 'pixel-border-dark text-text-muted hover:text-text-main'"
                        x-text="m.label"></button>
            </template>
        </div>

        <div class="pixel-card overflow-hidden" x-show="perfSummaries.length > 0">
            <div class="overflow-x-auto scrollbar-thin">
                <table class="w-full text-xs">
                    <thead>
                        <tr class="border-b border-border-main">
                            <th scope="col" class="sticky left-0 z-10 bg-bg-card px-3 py-2 text-left text-text-muted min-w-[120px]">策略</th>
                            <template x-for="col in periodColumns" :key="col.key">
                                <th class="px-2 py-2 text-right text-text-muted min-w-[70px] whitespace-nowrap" x-text="col.label"></th>
                            </template>
                            <th class="px-2 py-2 text-right text-text-muted min-w-[80px]">未實現</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="s in perfSummaries" :key="s.templateId">
                            <tr class="border-b border-border-main/50 hover:bg-white/[0.02]">
                                <td class="sticky left-0 z-10 bg-bg-card px-3 py-2">
                                    <div class="flex items-center gap-1">
                                        <span class="text-text-heading truncate max-w-[100px]" x-text="s.templateName"></span>
                                        <span x-show="s.systemDefault" class="text-sm text-primary">&#9733;</span>
                                    </div>
                                </td>
                                <template x-for="col in periodColumns" :key="col.key">
                                    <td class="px-2 py-2 text-right" :class="getCellColor(getMetricValue(s, col.key, selectedMetric))">
                                        <span x-text="formatMetric(getMetricValue(s, col.key, selectedMetric), selectedMetric)"></span>
                                    </td>
                                </template>
                                <td class="px-2 py-2 text-right" :class="getUnrealizedColor(s)">
                                    <span x-text="formatUnrealized(s)"></span>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
            <div class="px-3 py-1.5 border-t border-border-main/50 text-sm text-text-muted">
                <span x-show="lastComputedTime">最後更新: <span x-text="lastComputedTime"></span></span>
                <span x-show="!lastComputedTime">尚未計算</span>
            </div>
        </div>

        <div x-show="perfSummaries.length === 0 && !perfLoading" class="pixel-card p-6 text-center text-text-muted text-[13px]">
            點擊「重新計算」開始
        </div>
    </div>

    <!-- 編輯彈窗 -->
    <div x-show="showEditor" x-cloak class="fixed inset-0 z-[60] flex items-center justify-center bg-black/60" @click.self="showEditor = false">
        <div class="pixel-card p-5 w-[560px] max-w-[92vw] max-h-[85vh] overflow-y-auto scrollbar-thin">
            <h3 class="font-heading text-sm text-primary mb-4" x-text="'&#9998; 編輯：' + editing.name"></h3>
            <div class="mb-3">
                <label class="block text-xs text-text-muted mb-1">模板名稱</label>
                <input type="text" x-model="editing.name" class="w-full px-2 py-1.5 bg-bg-input pixel-border-dark text-text-main text-[13px] focus:outline-none">
            </div>
            <h4 class="text-[13px] text-text-heading mt-4 mb-2 border-b border-border-main pb-1">&#128295; 技術指標</h4>
            <div class="grid grid-cols-2 gap-2">
                <template x-for="field in indicatorFields" :key="field.key">
                    <div>
                        <label class="block text-xs text-text-muted mb-0.5" x-text="field.label"></label>
                        <input type="number" x-model.number="editing[field.key]" :step="field.step || 1"
                               class="w-full px-2 py-1 bg-bg-input pixel-border-dark text-text-main text-[13px] focus:outline-none">
                    </div>
                </template>
            </div>
            <h4 class="text-[13px] text-text-heading mt-4 mb-2 border-b border-border-main pb-1">&#128737; 風險控制</h4>
            <div class="grid grid-cols-2 gap-2">
                <template x-for="field in riskFields" :key="field.key">
                    <div>
                        <label class="block text-xs text-text-muted mb-0.5" x-text="field.label"></label>
                        <input type="number" x-model.number="editing[field.key]" :step="field.step || 1"
                               class="w-full px-2 py-1 bg-bg-input pixel-border-dark text-text-main text-[13px] focus:outline-none">
                    </div>
                </template>
            </div>
            <h4 class="text-[13px] text-text-heading mt-4 mb-2 border-b border-border-main pb-1">RSI 進出場</h4>
            <div class="grid grid-cols-2 gap-2">
                <template x-for="field in rsiFields" :key="field.key">
                    <div>
                        <label class="block text-xs text-text-muted mb-0.5" x-text="field.label"></label>
                        <input type="number" x-model.number="editing[field.key]" :step="field.step || 1"
                               class="w-full px-2 py-1 bg-bg-input pixel-border-dark text-text-main text-[13px] focus:outline-none">
                    </div>
                </template>
            </div>
            <div class="flex justify-end gap-2 mt-4 pt-3 border-t border-border-main">
                <button @click="showEditor = false" class="pixel-btn pixel-btn-purple text-[13px]">取消</button>
                <button @click="saveTemplate()" class="pixel-btn pixel-btn-gold text-[13px]">&#10003; 儲存</button>
            </div>
        </div>
    </div>

    <div x-show="message" x-cloak x-transition
         class="fixed bottom-4 right-4 pixel-card px-4 py-2 text-[13px] z-50"
         :class="messageType === 'success' ? 'text-positive' : 'text-negative'"
         x-text="message"></div>
</main>

<script>
    function strategiesApp() {
        return {
            templates: [], showEditor: false, editing: {}, message: '', messageType: 'success',
            loading: true,
            perfSummaries: [], perfLoading: false, selectedMetric: 'totalReturn', lastComputedTime: '',
            metricOptions: [
                { key: 'totalReturn', label: '累計報酬' }, { key: 'annualizedReturn', label: '年化報酬' },
                { key: 'winRate', label: '勝率' }, { key: 'maxDrawdown', label: '最大回撤' },
                { key: 'sharpeRatio', label: 'Sharpe' }, { key: 'totalTrades', label: '交易數' },
            ],
            periodColumns: [
                { key: 'SINCE_2021', label: '2021至今' }, { key: 'RECENT_5Y', label: '近5年' },
                { key: 'RECENT_3Y', label: '近3年' }, { key: 'RECENT_1Y', label: '近1年' },
                { key: 'RECENT_6M', label: '近6月' }, { key: 'RECENT_3M', label: '近3月' },
                { key: 'RECENT_1M', label: '近1月' },
            ],
            indicatorFields: [
                { key: 'emaShort', label: 'EMA 短期' }, { key: 'emaLong', label: 'EMA 長期' },
                { key: 'rsiPeriod', label: 'RSI 週期' }, { key: 'macdShort', label: 'MACD 快線' },
                { key: 'macdLong', label: 'MACD 慢線' }, { key: 'macdSignal', label: 'MACD 信號線' },
                { key: 'donchianEntry', label: '唐奇安進場' }, { key: 'donchianExit', label: '唐奇安出場' },
            ],
            riskFields: [
                { key: 'stopLossPct', label: '停損 (%)', step: 0.001 }, { key: 'maxHoldingDays', label: '最大持倉(天)' },
                { key: 'initialCapital', label: '模擬初始資金', step: 1000 }, { key: 'positionSizePct', label: '倉位比例 (0~1)', step: 0.05 },
                { key: 'trailingActivatePct', label: '停利啟動 (%)', step: 0.001 }, { key: 'trailingOffsetPct', label: '停利偏移 (%)', step: 0.001 },
                { key: 'timeStopDays', label: '時間止損(天)' }, { key: 'cooldownDays', label: '冷卻天數' },
                { key: 'maxTradesPerDay', label: '每日最大交易' },
            ],
            rsiFields: [
                { key: 'rsiLongEntryMin', label: '做多 RSI 下限' }, { key: 'rsiLongEntryMax', label: '做多 RSI 上限' },
                { key: 'rsiShortEntryMin', label: '做空 RSI 下限' }, { key: 'rsiShortEntryMax', label: '做空 RSI 上限' },
                { key: 'rsiLongExitExtreme', label: '做多出場極端' }, { key: 'rsiShortExitExtreme', label: '做空出場極端' },
            ],
            async init() { try { await this.loadTemplates(); await this.loadPerformance(); } finally { this.loading = false; } },
            async loadTemplates() { try { const r = await fetch('/api/user/strategies'); if (r.ok) this.templates = await r.json(); else this.showMsg('載入策略失敗','error'); } catch(e){ this.showMsg('網路異常，無法載入策略','error'); } },
            async loadPerformance() {
                try { const r = await fetch('/api/user/strategies/performance'); if (r.ok) { this.perfSummaries = await r.json();
                    const times = this.perfSummaries.filter(s=>s.lastComputedAt).map(s=>new Date(s.lastComputedAt));
                    if(times.length>0) this.lastComputedTime = new Date(Math.max(...times)).toLocaleString('zh-TW',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});
                }} catch(e){}
            },
            getMetricValue(s,pk,mk) { const p=s.periods?.find(p=>p.periodKey===pk); return p?p[mk]:null; },
            formatMetric(v,mk) { if(v===null||v===undefined)return'-'; const n=Number(v); if(isNaN(n))return'-';
                if(['totalReturn','annualizedReturn','maxDrawdown','winRate'].includes(mk))return(n*100).toFixed(1)+'%';
                if(mk==='sharpeRatio')return n.toFixed(2); if(mk==='totalTrades')return Math.round(n).toString(); return n.toFixed(2);
            },
            getCellColor(v) { if(v===null||v===undefined)return'text-text-muted'; const n=Number(v); if(isNaN(n))return'text-text-muted';
                if(this.selectedMetric==='maxDrawdown'){const a=Math.abs(n);if(a>0.25)return'text-red-400';if(a>0.15)return'text-yellow-400';return'text-green-400';}
                if(this.selectedMetric==='totalTrades')return'text-text-main'; return n>0?'text-green-400':n<0?'text-red-400':'text-text-muted';
            },
            getUnrealizedColor(s) { const p=s.periods?.find(p=>p.periodKey==='RECENT_1M'); if(!p||p.unrealizedPnlPct==null)return'text-text-muted'; return Number(p.unrealizedPnlPct)>=0?'text-green-400':'text-red-400'; },
            formatUnrealized(s) { const p=s.periods?.find(p=>p.periodKey==='RECENT_1M'); if(!p||p.unrealizedPnlPct==null)return'-';
                const pct=(Number(p.unrealizedPnlPct)*100).toFixed(2); const dir=p.unrealizedDirection==='LONG'?'L':'S'; const sign=Number(p.unrealizedPnlPct)>=0?'+':''; return `${dir} ${sign}${pct}%`; },
            async refreshAllPerformance() {
                this.perfLoading=true;
                const startTime = this.lastComputedTime || '';
                try {
                    const r=await fetch('/api/user/strategies/refresh-all-performance',{method:'POST'});
                    if(r.ok){
                        this.showMsg('績效計算中，請稍候...','success');
                        let attempts = 0;
                        const maxAttempts = 36;
                        const poll = async () => {
                            attempts++;
                            await this.loadPerformance();
                            if (this.lastComputedTime && this.lastComputedTime !== startTime) {
                                this.perfLoading = false;
                                this.showMsg('績效計算完成','success');
                            } else if (attempts < maxAttempts) {
                                setTimeout(poll, 5000);
                            } else {
                                this.perfLoading = false;
                                this.showMsg('計算可能仍在進行中，請稍後手動重新整理','info');
                            }
                        };
                        setTimeout(poll, 8000);
                    } else {this.perfLoading=false;this.showMsg('觸發失敗','error');}
                } catch(e){this.perfLoading=false;this.showMsg('網路錯誤','error');}
            },
            async cloneTemplate(id) { const name=await pixelPrompt('請輸入新卷軸名稱:'); if(!name)return; try { const r=await fetch('/api/user/strategies/clone',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sourceId:id,name})}); if(r.ok){const result=await r.json();this.showMsg('已複製卷軸「'+result.name+'」！','success');await this.loadTemplates();await this.loadPerformance();}else{const e=await r.json();this.showMsg(e.error||'克隆失敗','error');}} catch(e){this.showMsg('網路錯誤','error');} },
            openEditor(t) { this.editing=JSON.parse(JSON.stringify(t)); this.showEditor=true; },
            async saveTemplate() { try { const r=await fetch(`/api/user/strategies/${this.editing.id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(this.editing)}); if(r.ok){this.showEditor=false;this.showMsg('模板已更新','success');await this.loadTemplates();}else{const e=await r.json();this.showMsg(e.error||'更新失敗','error');}} catch(e){this.showMsg('網路錯誤','error');} },
            async deleteTemplate(id) { if(!await pixelConfirm('\u78BA\u5B9A\u8981\u522A\u9664\u6B64\u7B56\u7565\u6A21\u677F\u55CE\uFF1F'))return; try { const r=await fetch(`/api/user/strategies/${id}`,{method:'DELETE'}); if(r.ok){this.showMsg('\u6A21\u677F\u5DF2\u522A\u9664','success');await this.loadTemplates();await this.loadPerformance();}else{try{const e=await r.json();this.showMsg(e.error||'\u522A\u9664\u5931\u6557','error');}catch(_){this.showMsg('\u522A\u9664\u5931\u6557','error');}}} catch(e){this.showMsg('\u7DB2\u8DEF\u932F\u8AA4','error');} },
            showMsg(m,t) { this.message=m; this.messageType=t; setTimeout(()=>{this.message='';},3000); }
        };
    }
</script>
</body>
</html>
