<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-Hant">
<head th:replace="~{fragments/head :: head('BtcTrade - å‰¯æœ¬æŒ‘æˆ°')}"></head>
<body class="bg-bg-dark text-text-main min-h-screen">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>

<div th:replace="~{fragments/navbar :: navbar(${user})}"></div>
<div th:replace="~{fragments/pixel-overlay :: pixelOverlay}"></div>

<main class="pt-[60px] px-4 md:px-6 pb-12 max-w-6xl mx-auto" x-data="backtestApp()">

    <div class="mb-6">
        <h1 class="font-heading text-lg text-primary glow-gold">&#9889; å‰¯æœ¬æŒ‘æˆ°</h1>
        <p class="text-text-muted text-[13px] mt-1">é¸æ“‡ç­–ç•¥ï¼ŒæŒ‘æˆ°æ­·å²å¸‚å ´</p>
    </div>

    <!-- æŒ‘æˆ°é¢æ¿ -->
    <div class="pixel-card p-4 mb-4">
        <h2 class="text-sm text-text-heading mb-3">&#127919; ç™¼èµ·æŒ‘æˆ°</h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
            <div>
                <label class="block text-xs text-text-muted mb-1">ç­–ç•¥æ¨¡æ¿</label>
                <select x-model="form.templateId" class="w-full px-2 py-1.5 bg-bg-input pixel-border-dark text-text-main text-[13px] cursor-pointer focus:outline-none">
                    <option value="">è«‹é¸æ“‡...</option>
                    <template x-for="t in allTemplates" :key="t.id">
                        <option :value="t.id" x-text="t.name + (t.systemDefault ? ' &#9733;' : '')"></option>
                    </template>
                </select>
            </div>
            <div class="relative">
                <label class="block text-xs text-text-muted mb-1">äº¤æ˜“å°</label>
                <div class="relative">
                    <input type="text" x-model="symQuery" @input="symSearch()" @focus="symShowDrop = true; symSearch()"
                           @click.outside="symShowDrop = false"
                           placeholder="æœå°‹æˆ–è¼¸å…¥å¹£å°..."
                           class="w-full px-2 py-1.5 bg-bg-input pixel-border-dark text-text-main text-[13px] focus:outline-none uppercase">
                    <span x-show="symValidating" class="absolute right-2 top-1/2 -translate-y-1/2 text-warning text-xs anim-flash">...</span>
                </div>
                <!-- ä¸‹æ‹‰é¸å–® -->
                <div x-show="symShowDrop && (symMatches.length > 0 || symQuery.length >= 2)" x-cloak
                     class="absolute z-50 w-full mt-1 bg-bg-card pixel-border-dark max-h-48 overflow-y-auto scrollbar-thin">
                    <template x-for="s in symMatches" :key="s">
                        <button @click="symPick(s)" class="w-full text-left px-3 py-1.5 hover:bg-white/5 cursor-pointer text-[13px]"
                                :class="s === form.symbol ? 'text-primary' : 'text-text-main'" x-text="s"></button>
                    </template>
                    <!-- è‡ªè¨‚è¼¸å…¥æç¤º -->
                    <div x-show="symQuery.length >= 3 && symMatches.length === 0 && !symValidating" class="px-3 py-2 text-[13px]">
                        <span x-show="!symCustomValid && symCustomChecked" class="text-negative">&#10007; å¹£å°ä¸å­˜åœ¨</span>
                        <button x-show="symCustomValid" @click="symPickCustom()" class="text-cta hover:text-cta-hover cursor-pointer">
                            + æ–°å¢ <span x-text="symQuery.toUpperCase()"></span>ï¼ˆå°‡è‡ªå‹•åŒæ­¥è³‡æ–™ï¼‰
                        </button>
                    </div>
                </div>
            </div>
            <div>
                <label class="block text-xs text-text-muted mb-1">å›æ¸¬å¹´æ•¸</label>
                <select x-model.number="form.years" class="w-full px-2 py-1.5 bg-bg-input pixel-border-dark text-text-main text-[13px] cursor-pointer focus:outline-none">
                    <option value="1">1 å¹´</option><option value="2">2 å¹´</option><option value="3">3 å¹´</option><option value="5">5 å¹´</option>
                </select>
            </div>
            <div class="flex items-end">
                <button @click="submitBacktest()" :disabled="running || !form.templateId"
                        class="w-full pixel-btn pixel-btn-gold text-[13px] py-2 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span x-show="!running">&#9876; é–‹å§‹æŒ‘æˆ°ï¼</span>
                    <span x-show="running" class="flex items-center justify-center gap-2">
                        <span class="anim-flash">&#9876;</span>
                        <span x-text="'æŒ‘æˆ°ä¸­... ' + pollPct + '%'"></span>
                    </span>
                </button>
            </div>
        </div>
    </div>

    <!-- ===== å†’éšªå‹•ç•«å ´æ™¯ ===== -->
    <div x-show="running || advShowRewards" x-cloak class="pixel-card p-4 mb-4 relative overflow-hidden" style="min-height:180px;">
        <!-- å ´æ™¯èƒŒæ™¯ï¼šåœ°é¢+å¤©ç©º -->
        <div class="absolute inset-0" style="background: linear-gradient(180deg, #0c1021 0%, #1a1a2e 60%, #2d1f3d 80%, #3a2a1a 90%, #4a3a2a 100%);">
            <!-- æ˜Ÿæ˜Ÿ -->
            <div class="absolute" style="top:8px;left:15%;width:2px;height:2px;background:#fff;opacity:0.6;"></div>
            <div class="absolute" style="top:18px;left:45%;width:2px;height:2px;background:#fff;opacity:0.4;"></div>
            <div class="absolute" style="top:12px;left:72%;width:2px;height:2px;background:#fff;opacity:0.7;"></div>
            <div class="absolute" style="top:25px;left:88%;width:2px;height:2px;background:#fff;opacity:0.3;"></div>
            <!-- åœ°é¢è£é£¾ -->
            <div class="absolute bottom-0 left-0 right-0 h-[30px]" style="background: repeating-linear-gradient(90deg, #3a2a1a 0px, #4a3a2a 6px, #3a2a1a 12px);"></div>
        </div>

        <!-- é€²åº¦æ¢ -->
        <div class="relative z-10 mb-2">
            <div class="flex items-center justify-between text-[10px] text-text-muted mb-1">
                <span>å†’éšªé€²åº¦</span>
                <span x-text="pollPct + '%'"></span>
            </div>
            <div class="w-full h-2 bg-black/40 pixel-border-dark overflow-hidden">
                <div class="h-full bg-gradient-to-r from-primary to-cta transition-all duration-500"
                     :style="'width:' + pollPct + '%'"></div>
            </div>
        </div>

        <!-- è§’è‰²è¡Œèµ°å€åŸŸ -->
        <div class="relative z-10" style="height:100px;">
            <!-- è·¯å¾‘é‡Œç¨‹ç¢‘æ¨™è¨˜ -->
            <template x-for="evt in advEvents" :key="evt.pct">
                <div class="absolute bottom-[36px] z-10 transition-opacity duration-300"
                     :style="'left:' + evt.pct + '%'"
                     :class="pollPct >= evt.pct ? 'opacity-100' : 'opacity-30'">
                    <div class="text-[16px] -ml-2" x-text="evt.type === 'MONSTER' ? '&#128128;' : '&#127873;'"></div>
                </div>
            </template>

            <!-- è§’è‰²ç²¾éˆ -->
            <div class="absolute bottom-[30px] z-20 transition-all duration-[1500ms] ease-linear"
                 :style="'left: calc(' + Math.min(pollPct, 95) + '% - 24px)'"
                 :class="advCurrentScene === 'walk' ? 'anim-walk' : (advCurrentScene === 'attack' ? 'anim-attack' : 'anim-idle')">
                <div class="relative w-[48px] h-[48px]">
                    <div class="absolute top-0 left-0" :class="'pixel-char-' + charClass.toLowerCase()"></div>
                </div>
            </div>

            <!-- é­é‡æ€ªç‰©ï¼ˆè‡¨æ™‚é¡¯ç¤ºï¼‰ -->
            <div x-show="advCurrentMonster" x-transition class="absolute bottom-[30px] z-20"
                 :style="'left: calc(' + (advMonsterPct||0) + '% + 30px)'"
                 :class="advMonsterHurt ? 'anim-hurt' : 'anim-monster'">
                <div class="relative w-[48px] h-[48px]" x-show="advCurrentMonster">
                    <div class="absolute top-0 left-0" :class="advCurrentMonster?.monsterCss || ''"></div>
                </div>
            </div>

            <!-- æˆ°é¬¥æ–‡å­— -->
            <div x-show="advBattleText" x-transition class="absolute top-0 left-1/2 -translate-x-1/2 z-30">
                <div class="pixel-card px-3 py-1.5 text-[11px] font-heading text-center whitespace-nowrap"
                     :class="advBattleWin ? 'text-positive' : 'text-negative'"
                     x-text="advBattleText"></div>
            </div>

            <!-- å¯¶ç®± -->
            <div x-show="advShowTreasure" x-transition class="absolute bottom-[30px] z-20 anim-treasure-pop"
                 :style="'left: calc(' + (advTreasurePct||0) + '% - 8px)'">
                <div class="text-[32px]">&#127873;</div>
            </div>

            <!-- æˆ°åˆ©å“é£„å­— -->
            <template x-for="loot in advLootTexts" :key="loot.id">
                <div class="absolute z-30 anim-loot text-[11px] font-heading"
                     :style="'left:' + loot.x + '%;bottom:80px'"
                     :class="loot.color">
                    <span x-text="loot.text"></span>
                </div>
            </template>
        </div>

        <!-- äº‹ä»¶æ—¥èªŒ -->
        <div class="relative z-10 mt-2 max-h-[60px] overflow-y-auto scrollbar-thin">
            <template x-for="(log, i) in advLog" :key="i">
                <div class="text-[10px] leading-relaxed" :class="log.color || 'text-text-muted'" x-text="log.text"></div>
            </template>
        </div>
    </div>

    <!-- ===== å†’éšªçå‹µçµç®—é¢æ¿ ===== -->
    <div x-show="advShowRewards && advRewards" x-cloak class="pixel-card p-4 mb-4">
        <h3 class="text-sm font-heading text-primary mb-3">&#127942; å†’éšªçµç®—</h3>
        <!-- æˆ°é¬¥çµæœåˆ—è¡¨ -->
        <div class="space-y-2 mb-4 max-h-48 overflow-y-auto scrollbar-thin">
            <template x-for="(b, i) in advRewards?.battles || []" :key="i">
                <div class="flex items-center gap-3 text-xs px-2 py-1 bg-white/5 rounded">
                    <template x-if="b.type === 'TREASURE'">
                        <div class="flex items-center gap-2 w-full">
                            <span>&#127873;</span>
                            <span class="text-primary">ç™¼ç¾å¯¶ç®±ï¼</span>
                            <span class="ml-auto text-primary font-heading" x-text="'+' + b.gold + ' G'"></span>
                        </div>
                    </template>
                    <template x-if="b.type !== 'TREASURE'">
                        <div class="flex items-center gap-2 w-full">
                            <div class="w-[24px] h-[24px] relative shrink-0" style="transform:scale(0.5);transform-origin:top left;">
                                <div class="absolute top-0 left-0" :class="b.monsterCss || ''"></div>
                            </div>
                            <span class="text-text-heading" x-text="b.monsterName"></span>
                            <span class="text-[10px] text-text-muted" x-text="'Lv.' + b.monsterLevel"></span>
                            <template x-if="b.victory">
                                <div class="ml-auto flex items-center gap-2">
                                    <span class="text-positive text-[10px]">&#9989; å‹åˆ©</span>
                                    <span class="text-primary font-heading text-[10px]" x-text="'+' + b.exp + ' EXP'"></span>
                                    <span class="text-primary font-heading text-[10px]" x-text="'+' + b.gold + ' G'"></span>
                                </div>
                            </template>
                            <template x-if="!b.victory">
                                <div class="ml-auto">
                                    <span class="text-negative text-[10px]">&#10060; æ•—åŒ—</span>
                                    <span class="text-negative font-heading text-[10px]" x-text="'-' + b.goldLost + ' G'"></span>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
            </template>
        </div>
        <!-- çå‹µç¸½è¨ˆ -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3">
            <div class="pixel-card p-2 text-center">
                <div class="text-[10px] text-text-muted">ç²å¾— EXP</div>
                <div class="text-sm font-heading text-primary" x-text="'+' + (advRewards?.exp || 0)"></div>
            </div>
            <div class="pixel-card p-2 text-center">
                <div class="text-[10px] text-text-muted">ç²å¾—é‡‘å¹£</div>
                <div class="text-sm font-heading text-primary" x-text="'+' + (advRewards?.gold || 0) + ' G'"></div>
            </div>
            <div class="pixel-card p-2 text-center">
                <div class="text-[10px] text-text-muted">æ‰è½è£å‚™</div>
                <div class="text-sm font-heading text-cta" x-text="(advRewards?.equipment?.filter(e=>e.dropped)?.length || 0) + ' ä»¶'"></div>
            </div>
            <div class="pixel-card p-2 text-center">
                <div class="text-[10px] text-text-muted">å›æ¸¬åˆ¤å®š</div>
                <div class="text-sm font-heading" :class="advRewards?.profitable ? 'text-positive' : 'text-negative'"
                     x-text="advRewards?.profitable ? '&#127942; ç²åˆ©' : '&#128128; è™§æ'"></div>
            </div>
        </div>
        <!-- è£å‚™æ‰è½ -->
        <template x-if="advRewards?.equipment?.length > 0">
            <div class="mb-3">
                <div class="text-[11px] text-text-muted mb-1">&#128081; æ‰è½è£å‚™</div>
                <div class="flex flex-wrap gap-2">
                    <template x-for="eq in advRewards.equipment" :key="eq.name">
                        <div class="pixel-card px-2 py-1 text-[10px]"
                             :class="{'text-text-heading': eq.rarity==='COMMON', 'text-blue-400': eq.rarity==='RARE', 'text-purple-400': eq.rarity==='EPIC', 'text-primary': eq.rarity==='LEGENDARY'}">
                            <span x-text="eq.name"></span>
                            <span class="text-[9px] opacity-70" x-text="'(' + eq.rarity + ')'"></span>
                            <span x-show="!eq.dropped" class="text-negative text-[9px]">èƒŒåŒ…å·²æ»¿</span>
                        </div>
                    </template>
                </div>
            </div>
        </template>
    </div>

    <!-- çµæœå€åŸŸ -->
    <div x-show="result" x-cloak>
        <!-- æˆ°å ±å¡ç‰‡ -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
            <div class="pixel-card p-3">
                <span class="text-xs text-text-muted block mb-0.5">å¹´åŒ–å ±é…¬</span>
                <span class="text-base font-heading" :class="result?.annualizedReturn >= 0 ? 'text-positive' : 'text-negative'"
                      x-text="result ? (result.annualizedReturn * 100).toFixed(2) + '%' : '--'"></span>
            </div>
            <div class="pixel-card p-3">
                <span class="text-xs text-text-muted block mb-0.5">æœ€å¤§å›æ’¤</span>
                <span class="text-base font-heading text-negative" x-text="result ? (result.maxDrawdown * 100).toFixed(2) + '%' : '--'"></span>
            </div>
            <div class="pixel-card p-3">
                <span class="text-xs text-text-muted block mb-0.5">Sharpe</span>
                <span class="text-base font-heading text-primary" x-text="result?.sharpeRatio?.toFixed(2) || '--'"></span>
            </div>
            <div class="pixel-card p-3">
                <span class="text-xs text-text-muted block mb-0.5">å‹ç‡</span>
                <span class="text-base font-heading text-text-heading" x-text="result ? (result.winRate * 100).toFixed(1) + '%' : '--'"></span>
            </div>
            <div class="pixel-card p-3">
                <span class="text-xs text-text-muted block mb-0.5">ç¸½äº¤æ˜“æ•¸</span>
                <span class="text-base font-heading text-text-heading" x-text="result?.totalTrades || '--'"></span>
            </div>
            <div class="pixel-card p-3">
                <span class="text-xs text-text-muted block mb-0.5">Profit Factor</span>
                <span class="text-base font-heading text-primary" x-text="result?.profitFactor?.toFixed(2) || '--'"></span>
            </div>
            <div class="pixel-card p-3">
                <span class="text-xs text-text-muted block mb-0.5">ç´¯è¨ˆå ±é…¬</span>
                <span class="text-base font-heading" :class="result?.totalReturn >= 0 ? 'text-positive' : 'text-negative'"
                      x-text="result ? (result.totalReturn * 100).toFixed(2) + '%' : '--'"></span>
            </div>
            <div class="pixel-card p-3">
                <span class="text-xs text-text-muted block mb-0.5">åˆ¤å®š</span>
                <span class="text-base font-heading" :class="result?.passed ? 'text-positive' : 'text-negative'"
                      x-text="result?.passed ? '&#127942; PASSED' : '&#128128; FAILED'"></span>
            </div>
        </div>

        <!-- æ¬Šç›Šæ›²ç·š -->
        <div class="pixel-card p-4 mb-4">
            <h3 class="text-sm text-text-heading mb-3">&#128200; æ¬Šç›Šæ›²ç·š</h3>
            <div class="h-64"><canvas id="equityChart"></canvas></div>
        </div>

        <!-- äº¤æ˜“æ˜ç´° -->
        <div class="pixel-card p-4">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm text-text-heading">&#128220; äº¤æ˜“æ˜ç´°</h3>
                <span class="text-[11px] text-text-muted" x-show="totalTradePages > 1" x-text="'ç¬¬ ' + tradePage + '/' + totalTradePages + ' é ï¼ˆå…± ' + (result?.trades?.length||0) + ' ç­†ï¼‰'"></span>
            </div>
            <div class="overflow-x-auto scrollbar-thin">
                <table class="w-full text-xs">
                    <thead>
                    <tr class="text-text-muted border-b border-border-main">
                        <th scope="col" class="py-1.5 px-2 text-left">#</th><th scope="col" class="py-1.5 px-2 text-left">æ–¹å‘</th>
                        <th scope="col" class="py-1.5 px-2 text-left">é€²å ´</th>
                        <th scope="col" class="py-1.5 px-2 text-right">å ±é…¬ç‡</th><th scope="col" class="py-1.5 px-2 text-left">åŸå› </th>
                    </tr>
                    </thead>
                    <tbody>
                    <template x-for="trade in pagedTrades" :key="trade.tradeNumber">
                        <tr class="border-b border-border-main/50 hover:bg-white/5">
                            <td class="py-1.5 px-2 text-text-muted" x-text="trade.tradeNumber"></td>
                            <td class="py-1.5 px-2" :class="trade.direction === 'LONG' ? 'text-positive' : 'text-negative'" x-text="trade.direction === 'LONG' ? 'åšå¤š' : 'åšç©º'"></td>
                            <td class="py-1.5 px-2 text-text-muted" x-text="new Date(trade.entryTime).toLocaleDateString()"></td>
                            <td class="py-1.5 px-2 text-right" :class="parseFloat(trade.returnPct) >= 0 ? 'text-positive' : 'text-negative'" x-text="(parseFloat(trade.returnPct) * 100).toFixed(2) + '%'"></td>
                            <td class="py-1.5 px-2 text-text-muted" x-text="trade.exitReason"></td>
                        </tr>
                    </template>
                    </tbody>
                </table>
            </div>
            <!-- åˆ†é æ§åˆ¶ -->
            <div class="flex items-center justify-center gap-3 mt-3" x-show="totalTradePages > 1">
                <button @click="tradePage = Math.max(1, tradePage-1)" :disabled="tradePage <= 1"
                        class="pixel-btn text-[11px] py-1 px-3 disabled:opacity-30">&#9664; ä¸Šä¸€é </button>
                <button @click="tradePage = Math.min(totalTradePages, tradePage+1)" :disabled="tradePage >= totalTradePages"
                        class="pixel-btn text-[11px] py-1 px-3 disabled:opacity-30">ä¸‹ä¸€é  &#9654;</button>
            </div>
        </div>
    </div>

    <div x-show="message" x-cloak x-transition class="fixed bottom-4 right-4 pixel-card px-4 py-2 text-[13px] z-50"
         :class="messageType === 'success' ? 'text-positive' : 'text-negative'" x-text="message"></div>
</main>

<script th:inline="javascript">
    const _watchlist = /*[[${watchlistSymbols}]]*/ ['BTCUSDT'];
    const _readySymbols = /*[[${readySymbols}]]*/ ['BTCUSDT'];
    const _charClass = /*[[${charClass}]]*/ 'WARRIOR';
    const _userLevel = /*[[${userLevel}]]*/ 1;
    const watchlistSymbolList = _watchlist.length > 0 ? _watchlist : _readySymbols;
    let _symDebounce = null;
    let _lootId = 0;

    function backtestApp() {
        return {
            form: { templateId: '', symbol: watchlistSymbolList[0] || 'BTCUSDT', years: 5 },
            allTemplates: [], running: false, result: null,
            equityChart: null, message: '', messageType: 'success', pollPct: 0,
            tradePage: 1, tradesPerPage: 50,
            charClass: _charClass,
            get pagedTrades() { const t = this.result?.trades || []; const s = (this.tradePage-1)*this.tradesPerPage; return t.slice(s, s+this.tradesPerPage); },
            get totalTradePages() { return Math.ceil((this.result?.trades?.length || 0) / this.tradesPerPage); },

            // â”€â”€ å†’éšªå‹•ç•«ç‹€æ…‹ â”€â”€
            advEvents: [],           // å†’éšªäº‹ä»¶åˆ—è¡¨
            advCurrentScene: 'idle', // idle | walk | attack | treasure
            advCurrentMonster: null, // ç•¶å‰é­é‡çš„æ€ªç‰©
            advMonsterPct: 0,
            advMonsterHurt: false,
            advBattleText: '',
            advBattleWin: false,
            advShowTreasure: false,
            advTreasurePct: 0,
            advLog: [],
            advLootTexts: [],
            advShowRewards: false,
            advRewards: null,
            advTriggered: {},        // å·²è§¸ç™¼çš„é‡Œç¨‹ç¢‘
            advRunId: null,

            // å¹£å°æœå°‹
            symQuery: watchlistSymbolList[0] || 'BTCUSDT',
            symMatches: [], symShowDrop: false, symValidating: false,
            symCustomValid: false, symCustomChecked: false,

            async init() {
                await this.loadTemplates();
                this.symSearch();
                this.restoreAdventure();
            },

            async loadTemplates() {
                try {
                    const r = await fetch('/api/user/strategies');
                    if (r.ok) this.allTemplates = await r.json();
                    else this.showMsg('è¼‰å…¥ç­–ç•¥åˆ—è¡¨å¤±æ•—', 'error');
                } catch(e) { this.showMsg('ç¶²è·¯ç•°å¸¸', 'error'); }
            },

            // â”€â”€ å›æ¸¬æäº¤ â”€â”€
            async submitBacktest() {
                if (!this.form.templateId) return;
                this.running = true; this.result = null;
                this.advShowRewards = false; this.advRewards = null;
                this.advLog = []; this.advTriggered = {}; this.advEvents = [];
                this.advCurrentScene = 'walk';
                try {
                    const r = await fetch('/api/user/backtest/run', {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(this.form)
                    });
                    if (!r.ok) {
                        try { const e = await r.json(); this.showMsg(e.error || 'æäº¤å¤±æ•—', 'error'); }
                        catch(_) { this.showMsg('æäº¤å¤±æ•—', 'error'); }
                        this.running = false; this.advCurrentScene = 'idle'; return;
                    }
                    const data = await r.json();
                    this.advRunId = data.id;

                    // è§£æå†’éšªè¨ˆç•«
                    try {
                        const plan = JSON.parse(data.adventureJson || '{}');
                        this.advEvents = plan.events || [];
                    } catch(e) { this.advEvents = []; }

                    this.advLog.push({ text: 'âš” å†’éšªé–‹å§‹ï¼å‹‡å£«è¸ä¸Šå¾é€”...', color: 'text-primary' });
                    this.saveAdventure();
                    this.showMsg('æŒ‘æˆ°å·²é–‹å§‹...', 'success');
                    await this.pollResult(data.id);
                } catch(e) { this.showMsg('ç¶²è·¯éŒ¯èª¤', 'error'); this.running = false; this.advCurrentScene = 'idle'; }
            },

            // â”€â”€ è¼ªè©¢çµæœ + è§¸ç™¼å†’éšªäº‹ä»¶ â”€â”€
            async pollResult(runId) {
                this.pollPct = 0;
                for (let i = 0; i < 120; i++) {
                    this.pollPct = Math.min(99, Math.round((i / 120) * 100));
                    this.advCurrentScene = 'walk';

                    // æª¢æŸ¥æ˜¯å¦åˆ°é”é‡Œç¨‹ç¢‘
                    await this.checkMilestones();
                    this.saveAdventure();

                    await new Promise(r => setTimeout(r, 2000));
                    try {
                        const r = await fetch(`/api/user/backtest/${runId}`);
                        if (!r.ok) continue;
                        const d = await r.json();

                        if (d.status === 'COMPLETED') {
                            this.pollPct = 100;
                            this.result = JSON.parse(d.resultJson);
                            this.running = false;
                            this.advCurrentScene = 'idle';

                            // è§¸ç™¼å‰©é¤˜çš„é‡Œç¨‹ç¢‘äº‹ä»¶
                            await this.checkMilestones();

                            this.advLog.push({ text: this.result.passed ? 'ğŸ† å†’éšªå®Œæˆï¼è‹±é›„å‡±æ—‹æ­¸ä¾†ï¼' : 'ğŸ’€ å†’éšªçµæŸ... è‹±é›„æ‹–è‘—ç–²æ†Šçš„èº«è»€è¿”å›ç‡Ÿåœ°', color: this.result.passed ? 'text-positive' : 'text-negative' });

                            // è‡ªå‹•é ˜å–çå‹µ
                            if (!d.adventureRewardsClaimed) {
                                await this.claimRewards(runId);
                            }

                            this.showMsg(this.result.passed ? 'ğŸ† æŒ‘æˆ°æˆåŠŸï¼' : 'ğŸ’€ æŒ‘æˆ°å¤±æ•—', 'success');
                            this.$nextTick(() => this.renderChart());
                            this.clearSavedAdventure();
                            return;
                        } else if (d.status === 'FAILED') {
                            this.running = false; this.pollPct = 0;
                            this.advCurrentScene = 'idle';
                            this.advLog.push({ text: 'âŒ å›æ¸¬è¨ˆç®—å¤±æ•—', color: 'text-negative' });
                            this.showMsg('å›æ¸¬å¤±æ•—', 'error');
                            this.clearSavedAdventure();
                            return;
                        }
                    } catch(e) {}
                }
                this.running = false; this.pollPct = 0; this.advCurrentScene = 'idle';
                this.showMsg('è¶…æ™‚', 'error');
                this.clearSavedAdventure();
            },

            // â”€â”€ é‡Œç¨‹ç¢‘æª¢æŸ¥ + å‹•ç•«è§¸ç™¼ â”€â”€
            async checkMilestones() {
                for (const evt of this.advEvents) {
                    if (this.pollPct >= evt.pct && !this.advTriggered[evt.pct]) {
                        this.advTriggered[evt.pct] = true;
                        if (evt.type === 'MONSTER') {
                            await this.playMonsterEncounter(evt);
                        } else if (evt.type === 'TREASURE') {
                            await this.playTreasureEvent(evt);
                        }
                    }
                }
            },

            // â”€â”€ æ€ªç‰©é­é‡å‹•ç•« â”€â”€
            async playMonsterEncounter(evt) {
                this.advCurrentScene = 'idle';
                this.advCurrentMonster = evt;
                this.advMonsterPct = evt.pct;
                this.advLog.push({ text: `âš  é­é‡ ${evt.monsterName}ï¼ˆLv.${evt.monsterLevel}ï¼‰ï¼`, color: 'text-cta' });
                await this.sleep(800);

                // æ”»æ“Šå‹•ç•«
                this.advCurrentScene = 'attack';
                await this.sleep(500);

                // éš¨æ©Ÿå‹æ•—ï¼ˆå‰ç«¯åªåšå‹•ç•«ï¼Œå¯¦éš›çå‹µç”±å¾Œç«¯ claimRewards æ±ºå®šï¼‰
                const win = Math.random() < 0.6;
                this.advMonsterHurt = true;
                await this.sleep(600);

                if (win) {
                    this.advBattleText = `æ“Šæ•—äº† ${evt.monsterName}ï¼`;
                    this.advBattleWin = true;
                    this.advLog.push({ text: `âœ… æ“Šæ•— ${evt.monsterName}ï¼`, color: 'text-positive' });
                    this.spawnLoot(evt.pct, '+EXP', 'text-primary');
                } else {
                    this.advBattleText = `è¢« ${evt.monsterName} æ“Šé€€...`;
                    this.advBattleWin = false;
                    this.advLog.push({ text: `âŒ è¢« ${evt.monsterName} æ“Šé€€...`, color: 'text-negative' });
                }
                await this.sleep(1500);

                this.advBattleText = '';
                this.advCurrentMonster = null;
                this.advMonsterHurt = false;
                this.advCurrentScene = 'walk';
            },

            // â”€â”€ å¯¶ç®±äº‹ä»¶å‹•ç•« â”€â”€
            async playTreasureEvent(evt) {
                this.advCurrentScene = 'idle';
                this.advShowTreasure = true;
                this.advTreasurePct = evt.pct;
                this.advLog.push({ text: `ğŸ ç™¼ç¾å¯¶ç®±ï¼ç²å¾— ${evt.goldAmount} G`, color: 'text-primary' });
                this.spawnLoot(evt.pct, `+${evt.goldAmount} G`, 'text-primary');
                await this.sleep(2000);
                this.advShowTreasure = false;
                this.advCurrentScene = 'walk';
            },

            // â”€â”€ æˆ°åˆ©å“é£„å­—æ•ˆæœ â”€â”€
            spawnLoot(x, text, color) {
                const id = ++_lootId;
                this.advLootTexts.push({ id, x, text, color });
                setTimeout(() => {
                    this.advLootTexts = this.advLootTexts.filter(l => l.id !== id);
                }, 1500);
            },

            // â”€â”€ é ˜å–çå‹µ â”€â”€
            async claimRewards(runId) {
                try {
                    const r = await fetch(`/api/user/backtest/${runId}/adventure/claim`, { method: 'POST' });
                    if (r.ok) {
                        this.advRewards = await r.json();
                        this.advShowRewards = true;
                        this.advLog.push({ text: `ğŸ‰ ç²å¾— ${this.advRewards.exp} EXP, ${this.advRewards.gold} G`, color: 'text-primary' });
                    }
                } catch(e) {
                    console.error('Failed to claim adventure rewards', e);
                }
            },

            // â”€â”€ sessionStorage æŒä¹…åŒ– â”€â”€
            saveAdventure() {
                try {
                    sessionStorage.setItem('btc_adventure', JSON.stringify({
                        runId: this.advRunId, events: this.advEvents,
                        triggered: this.advTriggered, log: this.advLog,
                        pollPct: this.pollPct, running: this.running
                    }));
                } catch(e) {}
            },
            restoreAdventure() {
                try {
                    const saved = sessionStorage.getItem('btc_adventure');
                    if (!saved) return;
                    const s = JSON.parse(saved);
                    if (!s.running || !s.runId) { this.clearSavedAdventure(); return; }

                    // æ¢å¾©ç‹€æ…‹
                    this.advRunId = s.runId;
                    this.advEvents = s.events || [];
                    this.advTriggered = s.triggered || {};
                    this.advLog = s.log || [];
                    this.running = true;
                    this.advCurrentScene = 'walk';
                    this.pollPct = s.pollPct || 0;

                    // ç¹¼çºŒè¼ªè©¢
                    this.pollResult(s.runId);
                } catch(e) { this.clearSavedAdventure(); }
            },
            clearSavedAdventure() {
                try { sessionStorage.removeItem('btc_adventure'); } catch(e) {}
            },

            sleep(ms) { return new Promise(r => setTimeout(r, ms)); },

            renderChart() {
                const canvas = document.getElementById('equityChart');
                if (!canvas || !this.result?.equityCurve) return;
                if (this.equityChart) this.equityChart.destroy();
                const curve = this.result.equityCurve;
                const step = Math.max(1, Math.floor(curve.length / 500));
                const sampled = curve.filter((_, i) => i % step === 0);
                const initEquity = sampled.length > 0 ? parseFloat(sampled[0].equity) : 1;
                this.equityChart = new Chart(canvas.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: sampled.map(p => new Date(p.time).toLocaleDateString()),
                        datasets: [{
                            label: 'å ±é…¬ç‡',
                            data: sampled.map(p => ((parseFloat(p.equity) - initEquity) / initEquity * 100)),
                            borderColor: '#a855f7', backgroundColor: 'rgba(168,85,247,0.1)',
                            borderWidth: 2, fill: true, tension: 0, pointRadius: 0, stepped: 'before'
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: '#16213e', titleColor: '#e8e8f0', bodyColor: '#7a7a9a',
                                borderColor: '#2a2a4a', borderWidth: 2,
                                titleFont: { family: '"Exo 2"', size: 12 },
                                bodyFont: { family: '"Exo 2"', size: 11 },
                                callbacks: { label: ctx => ctx.parsed.y.toFixed(2) + '%' }
                            }
                        },
                        scales: {
                            x: { display: true, ticks: { color: '#7a7a9a', maxTicksLimit: 6, font: { family: '"Exo 2"', size: 10 } }, grid: { color: 'rgba(42,42,74,0.3)' } },
                            y: { display: true, ticks: { color: '#7a7a9a', font: { family: '"Exo 2"', size: 10 }, callback: v => v.toFixed(1) + '%' }, grid: { color: 'rgba(42,42,74,0.3)' } }
                        }
                    }
                });
            },

            showMsg(m, t) { this.message = m; this.messageType = t; setTimeout(() => { this.message = ''; }, 4000); },

            // â”€â”€ å¹£å°æœå°‹æ–¹æ³• â”€â”€
            symSearch() {
                const q = this.symQuery.toUpperCase().trim();
                this.symCustomValid = false; this.symCustomChecked = false;
                if (!q) { this.symMatches = watchlistSymbolList.slice(0, 20); return; }
                this.symMatches = watchlistSymbolList.filter(s => s.includes(q)).slice(0, 20);
                if (watchlistSymbolList.includes(q)) { this.form.symbol = q; return; }
                if (q.length >= 3 && this.symMatches.length === 0) {
                    clearTimeout(_symDebounce);
                    _symDebounce = setTimeout(() => this.symValidateCustom(q), 500);
                }
            },
            async symValidateCustom(symbol) {
                this.symValidating = true;
                try {
                    const r = await fetch('/api/symbols/validate?symbol=' + encodeURIComponent(symbol));
                    if (r.ok) { const d = await r.json(); this.symCustomValid = d.valid; this.symCustomChecked = true; }
                } catch(e) { this.symCustomChecked = true; }
                finally { this.symValidating = false; }
            },
            symPick(s) { this.symQuery = s; this.form.symbol = s; this.symShowDrop = false; },
            async symPickCustom() {
                const symbol = this.symQuery.toUpperCase().trim();
                try {
                    const r = await fetch('/api/symbols', { method: 'POST', headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({ symbol: symbol, displayName: symbol.replace('USDT','') + '/USDT' }) });
                    if (r.ok) {
                        watchlistSymbolList.push(symbol);
                        this.form.symbol = symbol; this.symShowDrop = false;
                        toast('å·²æ–°å¢ ' + symbol + 'ï¼Œè³‡æ–™åŒæ­¥ä¸­...', 'success');
                    } else {
                        const d = await r.json();
                        if (d.error?.includes('å·²åœ¨è¿½è¹¤')) {
                            if (!watchlistSymbolList.includes(symbol)) watchlistSymbolList.push(symbol);
                            this.form.symbol = symbol; this.symShowDrop = false;
                            toast(symbol + ' å·²åœ¨è¿½è¹¤ä¸­', 'info');
                        } else { toast(d.error || 'æ–°å¢å¤±æ•—', 'error'); }
                    }
                } catch(e) { toast('æ–°å¢å¤±æ•—', 'error'); }
            }
        };
    }
</script>
</body>
</html>
