<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-Hant">
<head th:replace="~{fragments/head :: head('BtcTrade - å‰¯æœ¬æŒ‘æˆ°')}"></head>
<body class="bg-bg-dark text-text-main min-h-screen">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.1.0/dist/chartjs-plugin-annotation.min.js"></script>

<div th:replace="~{fragments/navbar :: navbar(${user})}"></div>
<div th:replace="~{fragments/pixel-overlay :: pixelOverlay}"></div>

<main class="pt-[60px] px-4 md:px-6 pb-12 max-w-6xl mx-auto" x-data="backtestApp()">

    <div class="mb-6">
        <h1 class="font-heading text-lg text-primary glow-gold">&#9889; å‰¯æœ¬æŒ‘æˆ°</h1>
        <p class="text-text-muted text-[13px] mt-1">é¸æ“‡ç­–ç•¥ï¼ŒæŒ‘æˆ°æ­·å²å¸‚å ´</p>
    </div>

    <!-- æŒ‘æˆ°é¢æ¿ -->
    <div class="pixel-card p-4 mb-4">
        <h2 class="text-sm text-text-heading mb-3">&#127919; ç™¼èµ·æŒ‘æˆ°</h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
            <div>
                <label class="block text-xs text-text-muted mb-1">ç­–ç•¥æ¨¡æ¿</label>
                <select x-model="form.templateId" class="w-full px-2 py-1.5 bg-bg-input pixel-border-dark text-text-main text-[13px] cursor-pointer focus:outline-none">
                    <option value="">è«‹é¸æ“‡...</option>
                    <template x-for="t in allTemplates" :key="t.id">
                        <option :value="t.id" x-text="t.name + (t.systemDefault ? ' &#9733;' : '')"></option>
                    </template>
                </select>
            </div>
            <div class="relative">
                <label class="block text-xs text-text-muted mb-1">äº¤æ˜“å°</label>
                <div class="relative">
                    <input type="text" x-model="symQuery" @input="symSearch()" @focus="symShowDrop = true; $el.select(); symMatches = watchlistSymbolList.slice(0, 20)"
                           @click.outside="symShowDrop = false"
                           placeholder="æœå°‹æˆ–è¼¸å…¥å¹£å°..."
                           class="w-full px-2 py-1.5 bg-bg-input pixel-border-dark text-text-main text-[13px] focus:outline-none uppercase">
                    <span x-show="symValidating" class="absolute right-2 top-1/2 -translate-y-1/2 text-warning text-xs anim-flash">...</span>
                </div>
                <!-- ä¸‹æ‹‰é¸å–® -->
                <div x-show="symShowDrop && (symMatches.length > 0 || symQuery.length >= 2)" x-cloak
                     class="absolute z-50 w-full mt-1 bg-bg-card pixel-border-dark max-h-48 overflow-y-auto scrollbar-thin">
                    <template x-for="s in symMatches" :key="s">
                        <button @click="symPick(s)" class="w-full text-left px-3 py-1.5 hover:bg-white/5 cursor-pointer text-[13px]"
                                :class="s === form.symbol ? 'text-primary' : 'text-text-main'" x-text="s"></button>
                    </template>
                    <!-- è‡ªè¨‚è¼¸å…¥æç¤º -->
                    <div x-show="symQuery.length >= 3 && symMatches.length === 0 && !symValidating" class="px-3 py-2 text-[13px]">
                        <span x-show="!symCustomValid && symCustomChecked" class="text-negative">&#10007; å¹£å°ä¸å­˜åœ¨</span>
                        <button x-show="symCustomValid" @click="symPickCustom()" class="text-cta hover:text-cta-hover cursor-pointer">
                            + æ–°å¢ <span x-text="symQuery.toUpperCase()"></span>ï¼ˆå°‡è‡ªå‹•åŒæ­¥è³‡æ–™ï¼‰
                        </button>
                    </div>
                </div>
            </div>
            <div>
                <label class="block text-xs text-text-muted mb-1">å›æ¸¬å¹´æ•¸</label>
                <select x-model.number="form.years" class="w-full px-2 py-1.5 bg-bg-input pixel-border-dark text-text-main text-[13px] cursor-pointer focus:outline-none">
                    <option value="1">1 å¹´</option><option value="2">2 å¹´</option><option value="3">3 å¹´</option><option value="5">5 å¹´</option>
                </select>
            </div>
            <div class="flex items-end">
                <button @click="submitBacktest()" :disabled="running || !form.templateId || staminaData.stamina < form.years"
                        class="w-full pixel-btn pixel-btn-gold text-[13px] py-2 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span x-show="!running">&#9876; é–‹å§‹æŒ‘æˆ°ï¼</span>
                    <span x-show="running" class="flex items-center justify-center gap-2">
                        <span class="anim-flash">&#9876;</span>
                        <span x-text="'æŒ‘æˆ°ä¸­... ' + pollPct + '%'"></span>
                    </span>
                </button>
            </div>
        </div>
    </div>

    <!-- ===== é«”åŠ›é¢æ¿ ===== -->
    <div class="pixel-card p-3 mb-4 relative overflow-hidden">
        <div class="flex items-center justify-between gap-4">
            <!-- é«”åŠ›æ¢ -->
            <div class="flex-1">
                <div class="flex items-center justify-between text-[11px] mb-1">
                    <span class="text-text-muted">&#9889; é«”åŠ›</span>
                    <span class="font-heading" :class="staminaData.stamina <= 5 ? 'text-negative anim-flash' : 'text-primary'"
                          x-text="staminaData.stamina + ' / ' + staminaData.maxStamina"></span>
                </div>
                <div class="w-full h-3 bg-black/40 overflow-hidden" style="border:1px solid rgba(255,255,255,0.1);">
                    <div class="h-full transition-all duration-700"
                         :style="'width:' + (staminaData.stamina / staminaData.maxStamina * 100) + '%;background:linear-gradient(90deg,' + (staminaData.stamina <= 10 ? '#ef4444,#dc2626' : staminaData.stamina <= 25 ? '#f59e0b,#d97706' : '#4ade80,#22c55e') + ');'"></div>
                </div>
                <div class="flex items-center justify-between text-[10px] text-text-muted mt-1">
                    <span x-show="staminaData.stamina < staminaData.maxStamina" x-text="staminaRegenText"></span>
                    <span x-show="staminaData.stamina >= staminaData.maxStamina" class="text-positive">&#10003; é«”åŠ›å…¨æ»¿</span>
                    <span x-text="'æŒ‘æˆ°æ¶ˆè€—: ' + form.years + ' é»'"></span>
                </div>
            </div>
            <!-- ç¥çˆ¶ç¥ˆç¦±æŒ‰éˆ• -->
            <div class="shrink-0 text-center">
                <button @click="showPriestDialog = true"
                        :disabled="staminaData.stamina >= staminaData.maxStamina"
                        class="pixel-btn text-[10px] py-1.5 px-3 cursor-pointer disabled:opacity-30 disabled:cursor-not-allowed whitespace-nowrap"
                        :class="staminaData.stamina >= staminaData.maxStamina ? '' : 'pixel-btn-gold'">
                    &#9769; ç¥çˆ¶ç¥ˆç¦±
                </button>
                <div class="text-[9px] text-text-muted mt-0.5" x-text="staminaData.userGold + ' G'"></div>
            </div>
        </div>
    </div>

    <!-- ===== ç¥çˆ¶ç¥ˆç¦±å°è©±æ¡† ===== -->
    <div x-show="showPriestDialog" x-cloak x-transition
         class="fixed inset-0 z-50 flex items-center justify-center bg-black/60">
        <div class="pixel-card p-5 max-w-sm mx-4 relative" :class="priestPraying ? 'anim-priest-glow' : ''">
            <!-- ç¥ˆç¦±ä¸­å‹•ç•« -->
            <div x-show="priestPraying" class="text-center mb-4">
                <div class="inline-block relative">
                    <div class="w-[40px] h-[40px] mx-auto relative"><div class="absolute top-0 left-0 pixel-priest"></div></div>
                    <div class="text-2xl anim-cross-shine mt-2">&#10013;</div>
                </div>
                <div class="text-sm font-heading text-primary mt-2 anim-flash">ç¥ˆç¦±ä¸­...</div>
                <template x-for="ft in priestFloatTexts" :key="ft.id">
                    <div class="absolute anim-priest-float text-xs font-heading text-primary"
                         :style="'left:' + ft.x + '%;top:40%'" x-text="ft.text"></div>
                </template>
            </div>
            <!-- æ­£å¸¸ä»‹é¢ -->
            <div x-show="!priestPraying">
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-[40px] h-[40px] relative shrink-0"><div class="absolute top-0 left-0 pixel-priest"></div></div>
                    <div>
                        <h3 class="text-sm font-heading text-primary">&#9769; ç¥çˆ¶ç¥ˆç¦±</h3>
                        <p class="text-[11px] text-text-muted mt-0.5">é€éç¥è–åŠ›é‡æ¢å¾©é«”åŠ›</p>
                    </div>
                </div>
                <div class="space-y-2 mb-4">
                    <div class="flex justify-between text-xs">
                        <span class="text-text-muted">ç›®å‰é«”åŠ›</span>
                        <span class="text-text-heading" x-text="staminaData.stamina + ' / ' + staminaData.maxStamina"></span>
                    </div>
                    <div class="flex justify-between text-xs">
                        <span class="text-text-muted">éœ€æ¢å¾©</span>
                        <span class="text-primary" x-text="(staminaData.maxStamina - staminaData.stamina) + ' é»'"></span>
                    </div>
                    <div class="flex justify-between text-xs">
                        <span class="text-text-muted">è²»ç”¨</span>
                        <span class="font-heading text-primary" x-text="priestCost + ' G'"></span>
                    </div>
                    <div class="flex justify-between text-xs">
                        <span class="text-text-muted">æŒæœ‰é‡‘å¹£</span>
                        <span :class="staminaData.userGold >= priestCost ? 'text-positive' : 'text-negative'"
                              x-text="staminaData.userGold + ' G'"></span>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button @click="showPriestDialog = false"
                            class="flex-1 pixel-btn text-[11px] py-1.5 cursor-pointer">å–æ¶ˆ</button>
                    <button @click="priestRestore()"
                            :disabled="staminaData.userGold < priestCost || priestCost <= 0"
                            class="flex-1 pixel-btn pixel-btn-gold text-[11px] py-1.5 cursor-pointer disabled:opacity-30 disabled:cursor-not-allowed">
                        &#9769; ç¥ˆç¦±æ¢å¾©
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== å†’éšªå‹•ç•«å ´æ™¯ ===== -->
    <div x-show="running || advShowRewards" x-cloak class="pixel-card mb-4 relative overflow-hidden">
        <!-- ä¸ŠåŠï¼šæˆ°é¬¥åŠ‡å ´ -->
        <div class="relative" style="height:260px;background:linear-gradient(180deg,#0c1021 0%,#1a1a2e 40%,#2d1f3d 70%,#3a2a1a 88%,#4a3a2a 100%);">
            <!-- æ˜Ÿæ˜Ÿ -->
            <div class="absolute" style="top:8px;left:15%;width:2px;height:2px;background:#fff;opacity:0.6;"></div>
            <div class="absolute" style="top:18px;left:45%;width:2px;height:2px;background:#fff;opacity:0.4;"></div>
            <div class="absolute" style="top:12px;left:72%;width:2px;height:2px;background:#fff;opacity:0.7;"></div>
            <div class="absolute" style="top:25px;left:88%;width:2px;height:2px;background:#fff;opacity:0.3;"></div>
            <div class="absolute" style="top:5px;left:30%;width:2px;height:2px;background:#ffd642;opacity:0.5;"></div>
            <div class="absolute" style="top:22px;left:60%;width:2px;height:2px;background:#fff;opacity:0.4;"></div>
            <!-- åœ°é¢ -->
            <div class="absolute bottom-0 left-0 right-0 h-[40px]" style="background:repeating-linear-gradient(90deg,#3a2a1a 0px,#4a3a2a 6px,#3a2a1a 12px);"></div>

            <!-- é€²åº¦æ¢ï¼ˆé ‚éƒ¨ï¼‰ -->
            <div class="absolute top-0 left-0 right-0 z-20 px-3 pt-2">
                <div class="flex items-center justify-between text-[10px] text-white/60 mb-1">
                    <span>&#9876; å†’éšªé€²åº¦</span>
                    <div class="flex items-center gap-2">
                        <span x-show="running && pollPct < 100" class="text-white/40" x-text="estimatedTime"></span>
                        <span x-text="pollPct + '%'"></span>
                    </div>
                </div>
                <div class="w-full h-1.5 bg-black/40 overflow-hidden" style="border:1px solid rgba(255,255,255,0.1);">
                    <div class="h-full transition-all duration-500"
                         style="background:linear-gradient(90deg,#f59e0b,#8b5cf6);"
                         :style="'width:' + pollPct + '%'"></div>
                </div>
            </div>

            <!-- éæˆ°é¬¥æ™‚ï¼šè¡Œèµ°å ´æ™¯ -->
            <div x-show="!advInBattle" class="absolute inset-0 z-10">
                <!-- è·¯å¾‘é‡Œç¨‹ç¢‘æ¨™è¨˜ -->
                <template x-for="evt in advEvents" :key="evt.pct">
                    <div class="absolute z-10 transition-opacity duration-300"
                         :style="'left:' + evt.pct + '%;bottom:50px'"
                         :class="advTriggered[evt.pct] ? 'opacity-30' : (pollPct >= evt.pct - 5 ? 'opacity-100' : 'opacity-40')">
                        <div class="text-[20px] -ml-2" x-text="evt.type === 'MONSTER' ? '&#128128;' : '&#127873;'"></div>
                    </div>
                </template>
                <!-- è§’è‰²è¡Œèµ° -->
                <div class="absolute z-20 transition-all duration-[1500ms] ease-linear"
                     :style="'left:calc(' + Math.min(pollPct, 92) + '% - 24px);bottom:44px'"
                     :class="advCurrentScene === 'walk' ? 'anim-walk' : 'anim-idle'">
                    <div class="sprite-container">
                        <div class="absolute top-0 left-0" :class="'pixel-char-' + charClass.toLowerCase()"></div>
                        <template x-if="equippedWeaponCss">
                            <div class="sprite-weapon-overlay" :class="equippedWeaponCss + ' ' + rarityGlowClass(weaponRarity)"></div>
                        </template>
                        <template x-if="equippedArmorCss">
                            <div class="sprite-armor-overlay" :class="equippedArmorCss + ' ' + rarityGlowClass(armorRarity)"></div>
                        </template>
                    </div>
                </div>
                <!-- å¯¶ç®±äº‹ä»¶ -->
                <div x-show="advShowTreasure" x-transition class="absolute z-20 anim-treasure-pop"
                     :style="'left:calc(' + (advTreasurePct||0) + '% - 8px);bottom:44px'">
                    <div class="text-[36px]">&#127873;</div>
                </div>
                <!-- é£„å­— -->
                <template x-for="loot in advLootTexts" :key="loot.id">
                    <div class="absolute z-30 anim-loot text-xs font-heading"
                         :style="'left:' + loot.x + '%;bottom:110px'"
                         :class="loot.color" x-text="loot.text"></div>
                </template>
            </div>

            <!-- æˆ°é¬¥æ™‚ï¼šRPG æˆ°é¬¥åŠ‡å ´ -->
            <div x-show="advInBattle" x-transition class="absolute inset-0 z-10 flex items-end justify-center pb-[50px]">
                <!-- å·¦å´ï¼šéšŠä¼ï¼ˆä¸»è§’ + éšŠå“¡ï¼‰ -->
                <div class="flex items-end mr-4 md:mr-8">
                    <!-- éšŠå“¡ï¼ˆä¸»è§’èº«å¾Œï¼Œè·Ÿéš¨ä¸»è§’å‹•ç•«ï¼‰ -->
                    <div x-show="partyMembers.length > 0" class="flex flex-col gap-0.5 mr-1 mb-1">
                        <template x-for="(m, mi) in partyMembers" :key="m.id">
                            <div class="flex flex-col items-center">
                                <div class="text-[7px] font-heading text-cta/70 truncate max-w-[32px]" x-text="m.name"></div>
                                <div class="w-[32px] h-[32px] relative opacity-70"
                                     :class="advPlayerAnim === 'anim-attack' ? 'anim-attack' : (advPlayerAnim === 'anim-hurt' ? 'anim-hurt' : 'anim-idle')">
                                    <div class="absolute top-0 left-0" :class="'pixel-char-' + m.characterClass.toLowerCase()"
                                         style="transform:scale(0.65);transform-origin:top left;"></div>
                                </div>
                            </div>
                        </template>
                    </div>
                    <!-- ä¸»è§’ -->
                    <div class="flex flex-col items-center relative">
                        <!-- è§’è‰²å + HP -->
                        <div class="mb-1 text-center">
                            <div class="text-[10px] text-primary font-heading" x-text="charClass"></div>
                            <div class="w-16 h-1.5 bg-black/60 mt-0.5 overflow-hidden" style="border:1px solid #4a90d9;">
                                <div class="h-full bg-positive transition-all duration-300" :style="'width:' + advPlayerHp + '%'"></div>
                            </div>
                        </div>
                        <!-- è§’è‰²ç²¾éˆï¼ˆåˆ†å±¤ï¼šè§’è‰² + æ­¦å™¨ + é˜²å…·ï¼‰ -->
                        <div class="sprite-container"
                             :class="advPlayerAnim">
                            <div class="absolute top-0 left-0" :class="'pixel-char-' + charClass.toLowerCase()"></div>
                            <template x-if="equippedWeaponCss">
                                <div class="sprite-weapon-overlay" :class="equippedWeaponCss + ' ' + rarityGlowClass(weaponRarity)"></div>
                            </template>
                            <template x-if="equippedArmorCss">
                                <div class="sprite-armor-overlay" :class="equippedArmorCss + ' ' + rarityGlowClass(armorRarity)"></div>
                            </template>
                        </div>
                        <!-- æŠ€èƒ½å -->
                        <div x-show="advSkillName" x-transition
                             class="absolute -top-4 left-1/2 -translate-x-1/2 whitespace-nowrap">
                            <span class="text-[10px] font-heading text-cta px-1.5 py-0.5"
                                  style="background:rgba(139,92,246,0.3);border:1px solid rgba(139,92,246,0.5);"
                                  x-text="advSkillName"></span>
                        </div>
                    </div>
                </div>

                <!-- ä¸­å¤®ï¼šVS + æˆ°æ³æ–‡å­— -->
                <div class="flex flex-col items-center mx-2 md:mx-4 mb-6">
                    <div x-show="advBattleText" x-transition
                         class="px-3 py-1.5 text-[11px] font-heading text-center whitespace-nowrap mb-2"
                         style="background:rgba(0,0,0,0.7);border:1px solid rgba(255,255,255,0.2);"
                         :class="advBattleWin ? 'text-positive' : (advBattleWin === false ? 'text-negative' : 'text-primary')"
                         x-text="advBattleText"></div>
                    <div x-show="!advBattleText" class="text-lg font-heading text-white/30 anim-flash">VS</div>
                    <!-- å‚·å®³æ•¸å­— -->
                    <template x-for="dmg in advDmgTexts" :key="dmg.id">
                        <div class="absolute anim-loot font-heading"
                             :style="'left:' + dmg.x + '%;bottom:70%'"
                             :class="dmg.color" x-text="dmg.text"
                             style="font-size:14px;"></div>
                    </template>
                </div>

                <!-- å³å´ï¼šæ€ªç‰© -->
                <div class="flex flex-col items-center ml-8 md:ml-16 relative" x-show="advCurrentMonster">
                    <!-- æ€ªç‰©å + HP -->
                    <div class="mb-1 text-center">
                        <div class="text-[10px] font-heading"
                             :class="{'text-positive':advCurrentMonster?.riskTier==='LOW','text-primary':advCurrentMonster?.riskTier==='MEDIUM','text-cta':advCurrentMonster?.riskTier==='HIGH','text-negative':advCurrentMonster?.riskTier==='EXTREME'}"
                             x-text="(advCurrentMonster?.monsterName||'') + ' Lv.' + (advCurrentMonster?.monsterLevel||0)"></div>
                        <div class="w-16 h-1.5 bg-black/60 mt-0.5 overflow-hidden" style="border:1px solid #ef4444;">
                            <div class="h-full bg-negative transition-all duration-300" :style="'width:' + advMonsterHp + '%'"></div>
                        </div>
                    </div>
                    <!-- æ€ªç‰©ç²¾éˆ -->
                    <div class="w-[48px] h-[48px] relative"
                         :class="advMonsterAnim">
                        <div class="absolute top-0 left-0" :class="advCurrentMonster?.monsterCss || ''"></div>
                    </div>
                    <!-- æ€ªç‰©æŠ€èƒ½å -->
                    <div x-show="advMonsterSkill" x-transition
                         class="absolute -top-4 left-1/2 -translate-x-1/2 whitespace-nowrap">
                        <span class="text-[10px] font-heading text-negative px-1.5 py-0.5"
                              style="background:rgba(239,68,68,0.3);border:1px solid rgba(239,68,68,0.5);"
                              x-text="advMonsterSkill"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä¸‹åŠï¼šæˆ°é¬¥æ—¥èªŒ + Skip æŒ‰éˆ• -->
        <div class="px-4 py-3 flex gap-3" style="background:#12121f;">
            <div x-ref="advLogBox" class="flex-1 max-h-[100px] overflow-y-auto scrollbar-thin space-y-0.5">
                <template x-for="(log, i) in advLog" :key="i">
                    <div class="text-[11px] leading-relaxed" :class="log.color || 'text-text-muted'" x-text="log.text"></div>
                </template>
            </div>
            <button x-show="running" @click="skipAdventure()"
                    class="shrink-0 self-end pixel-btn text-[10px] py-1 px-3 cursor-pointer text-text-muted hover:text-primary transition-colors"
                    title="è·³éå‹•ç•«ç›´æ¥æŸ¥çœ‹çµæœ">
                &#9654;&#9654; è·³é
            </button>
        </div>
    </div>

    <!-- ===== å†’éšªçå‹µçµç®—é¢æ¿ ===== -->
    <div x-show="advShowRewards && advRewards" x-cloak class="pixel-card p-4 mb-4">
        <h3 class="text-sm font-heading text-primary mb-3">&#127942; å†’éšªçµç®—</h3>
        <!-- æˆ°é¬¥çµæœåˆ—è¡¨ -->
        <div class="space-y-2 mb-4 max-h-52 overflow-y-auto scrollbar-thin">
            <template x-for="(b, i) in advRewards?.battles || []" :key="i">
                <div class="flex items-center gap-3 text-xs px-2 py-1.5 bg-white/5 rounded">
                    <template x-if="b.type === 'TREASURE'">
                        <div class="flex items-center gap-2 w-full">
                            <span class="text-lg">&#127873;</span>
                            <span class="text-primary">ç™¼ç¾å¯¶ç®±ï¼</span>
                            <span class="ml-auto text-primary font-heading" x-text="'+' + b.gold + ' G'"></span>
                        </div>
                    </template>
                    <template x-if="b.type !== 'TREASURE'">
                        <div class="flex items-center gap-2 w-full">
                            <div class="w-6 h-6 relative shrink-0" style="transform:scale(0.5);transform-origin:top left;">
                                <div class="absolute top-0 left-0" :class="b.monsterCss || ''"></div>
                            </div>
                            <span class="text-text-heading" x-text="b.monsterName"></span>
                            <span class="text-[10px] text-text-muted" x-text="'Lv.' + b.monsterLevel"></span>
                            <template x-if="b.victory">
                                <div class="ml-auto flex items-center gap-2">
                                    <span class="text-positive text-[10px]">&#9989; å‹åˆ©</span>
                                    <span class="text-primary font-heading text-[10px]" x-text="'+' + b.exp + ' EXP'"></span>
                                    <span class="text-primary font-heading text-[10px]" x-text="'+' + b.gold + ' G'"></span>
                                </div>
                            </template>
                            <template x-if="!b.victory">
                                <div class="ml-auto flex items-center gap-2">
                                    <span class="text-negative text-[10px]">&#10060; æ•—åŒ—</span>
                                    <span class="text-negative font-heading text-[10px]" x-text="'-' + (b.goldLost||0) + ' G'"></span>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
            </template>
        </div>
        <!-- çå‹µç¸½è¨ˆ -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3">
            <div class="pixel-card p-2 text-center">
                <div class="text-[10px] text-text-muted">ç²å¾— EXP</div>
                <div class="text-sm font-heading text-primary" x-text="'+' + (advRewards?.exp || 0)"></div>
            </div>
            <div class="pixel-card p-2 text-center">
                <div class="text-[10px] text-text-muted">ç²å¾—é‡‘å¹£</div>
                <div class="text-sm font-heading text-primary" x-text="'+' + (advRewards?.gold || 0) + ' G'"></div>
            </div>
            <div class="pixel-card p-2 text-center">
                <div class="text-[10px] text-text-muted">æ‰è½è£å‚™</div>
                <div class="text-sm font-heading text-cta" x-text="(advRewards?.equipment?.filter(e=>e.dropped)?.length || 0) + ' ä»¶'"></div>
            </div>
            <div class="pixel-card p-2 text-center">
                <div class="text-[10px] text-text-muted">å›æ¸¬åˆ¤å®š</div>
                <div class="text-sm font-heading" :class="advRewards?.profitable ? 'text-positive' : 'text-negative'"
                     x-text="advRewards?.profitable ? '&#127942; ç²åˆ©' : '&#128128; è™§æ'"></div>
            </div>
        </div>
        <!-- è£å‚™æ‰è½ -->
        <template x-if="advRewards?.equipment?.length > 0">
            <div class="mb-1">
                <div class="text-[11px] text-text-muted mb-1">&#128081; æ‰è½è£å‚™</div>
                <div class="flex flex-wrap gap-2">
                    <template x-for="eq in advRewards.equipment" :key="eq.name">
                        <div class="pixel-card px-2 py-1 text-[10px]"
                             :class="{'text-text-heading':eq.rarity==='COMMON','text-blue-400':eq.rarity==='RARE','text-purple-400':eq.rarity==='EPIC','text-primary':eq.rarity==='LEGENDARY'}">
                            <span x-text="eq.name"></span>
                            <span class="text-[9px] opacity-70" x-text="'(' + eq.rarity + ')'"></span>
                            <span x-show="!eq.dropped" class="text-negative text-[9px]">èƒŒåŒ…å·²æ»¿</span>
                        </div>
                    </template>
                </div>
            </div>
        </template>
    </div>

    <!-- çµæœå€åŸŸ -->
    <div x-show="result" x-cloak>
        <!-- å›æ¸¬è³‡è¨Šæ¬„ -->
        <div class="pixel-card p-3 mb-4 flex flex-wrap items-center gap-x-6 gap-y-1 text-xs text-text-muted">
            <span x-show="result?.startDate && result?.endDate">
                <span class="text-text-heading">å›æ¸¬å€é–“ï¼š</span>
                <span x-text="result?.startDate + ' ~ ' + result?.endDate"></span>
            </span>
            <span x-show="backtestElapsedSec > 0">
                <span class="text-text-heading">è€—æ™‚ï¼š</span>
                <span x-text="backtestElapsedSec >= 60 ? Math.floor(backtestElapsedSec/60) + 'åˆ†' + (backtestElapsedSec%60) + 'ç§’' : backtestElapsedSec + 'ç§’'"></span>
            </span>
            <span x-show="result?.totalBars">
                <span class="text-text-heading">K ç·šæ•¸ï¼š</span>
                <span x-text="result?.totalBars?.toLocaleString()"></span>
            </span>
        </div>
        <!-- æˆ°å ±å¡ç‰‡ -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
            <div class="pixel-card p-3">
                <span class="text-xs text-text-muted block mb-0.5">å¹´åŒ–å ±é…¬</span>
                <span class="text-base font-heading" :class="result?.annualizedReturn >= 0 ? 'text-positive' : 'text-negative'"
                      x-text="result ? (result.annualizedReturn * 100).toFixed(2) + '%' : '--'"></span>
            </div>
            <div class="pixel-card p-3">
                <span class="text-xs text-text-muted block mb-0.5">æœ€å¤§å›æ’¤</span>
                <span class="text-base font-heading text-negative" x-text="result ? (result.maxDrawdown * 100).toFixed(2) + '%' : '--'"></span>
            </div>
            <div class="pixel-card p-3">
                <span class="text-xs text-text-muted block mb-0.5">Sharpe</span>
                <span class="text-base font-heading text-primary" x-text="result?.sharpeRatio?.toFixed(2) || '--'"></span>
            </div>
            <div class="pixel-card p-3">
                <span class="text-xs text-text-muted block mb-0.5">å‹ç‡</span>
                <span class="text-base font-heading text-text-heading" x-text="result ? (result.winRate * 100).toFixed(1) + '%' : '--'"></span>
            </div>
            <div class="pixel-card p-3">
                <span class="text-xs text-text-muted block mb-0.5">ç¸½äº¤æ˜“æ•¸</span>
                <span class="text-base font-heading text-text-heading" x-text="result?.totalTrades || '--'"></span>
            </div>
            <div class="pixel-card p-3">
                <span class="text-xs text-text-muted block mb-0.5">Profit Factor</span>
                <span class="text-base font-heading text-primary" x-text="result?.profitFactor?.toFixed(2) || '--'"></span>
            </div>
            <div class="pixel-card p-3">
                <span class="text-xs text-text-muted block mb-0.5">ç´¯è¨ˆå ±é…¬</span>
                <span class="text-base font-heading" :class="result?.totalReturn >= 0 ? 'text-positive' : 'text-negative'"
                      x-text="result ? (result.totalReturn * 100).toFixed(2) + '%' : '--'"></span>
            </div>
            <div class="pixel-card p-3">
                <span class="text-xs text-text-muted block mb-0.5">åˆ¤å®š</span>
                <span class="text-base font-heading" :class="result?.passed ? 'text-positive' : 'text-negative'"
                      x-text="result?.passed ? '&#127942; ç²åˆ©ç­–ç•¥' : '&#128128; è™§æç­–ç•¥'"></span>
            </div>
        </div>

        <!-- æ¬Šç›Šæ›²ç·š -->
        <div class="pixel-card p-4 mb-4">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm text-text-heading">&#128200; æ¬Šç›Šæ›²ç·š</h3>
                <div class="flex items-center gap-2">
                    <button @click="showEvents = !showEvents; renderChart()"
                            class="pixel-btn text-[9px] py-0.5 px-2 cursor-pointer"
                            :class="showEvents ? 'pixel-btn-gold' : 'pixel-btn-purple'">
                        <span x-text="showEvents ? '&#128205; äº‹ä»¶ ON' : '&#128205; äº‹ä»¶ OFF'"></span>
                    </button>
                </div>
            </div>
            <div class="h-64"><canvas id="equityChart"></canvas></div>
            <!-- äº‹ä»¶åœ–ä¾‹ -->
            <div x-show="showEvents && historicalEvents.length > 0" class="flex flex-wrap gap-3 mt-2 text-[9px] text-text-muted">
                <span><span class="inline-block w-2 h-2 bg-yellow-500 mr-1"></span>æ¸›åŠ</span>
                <span><span class="inline-block w-2 h-2 bg-green-500 mr-1"></span>åˆ©å¤š</span>
                <span><span class="inline-block w-2 h-2 bg-red-500 mr-1"></span>åˆ©ç©º</span>
                <span><span class="inline-block w-2 h-2 bg-blue-500 mr-1"></span>ç›£ç®¡</span>
                <span class="ml-2" x-text="'(' + historicalEvents.length + ' å€‹äº‹ä»¶)'"></span>
            </div>
        </div>

        <!-- äº¤æ˜“æ˜ç´° -->
        <div class="pixel-card p-4">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm text-text-heading">&#128220; äº¤æ˜“æ˜ç´°</h3>
                <span class="text-[11px] text-text-muted" x-show="totalTradePages > 1" x-text="'ç¬¬ ' + tradePage + '/' + totalTradePages + ' é ï¼ˆå…± ' + (result?.trades?.length||0) + ' ç­†ï¼‰'"></span>
            </div>
            <div class="overflow-x-auto scrollbar-thin">
                <table class="w-full text-xs">
                    <thead>
                    <tr class="text-text-muted border-b border-border-main">
                        <th scope="col" class="py-1.5 px-2 text-left">#</th><th scope="col" class="py-1.5 px-2 text-left">æ–¹å‘</th>
                        <th scope="col" class="py-1.5 px-2 text-left">é€²å ´</th>
                        <th scope="col" class="py-1.5 px-2 text-right">å ±é…¬ç‡</th><th scope="col" class="py-1.5 px-2 text-left">åŸå› </th>
                    </tr>
                    </thead>
                    <tbody>
                    <template x-for="trade in pagedTrades" :key="trade.tradeNumber">
                        <tr class="border-b border-border-main/50 hover:bg-white/5">
                            <td class="py-1.5 px-2 text-text-muted" x-text="trade.tradeNumber"></td>
                            <td class="py-1.5 px-2" :class="trade.direction === 'LONG' ? 'text-positive' : 'text-negative'" x-text="trade.direction === 'LONG' ? 'åšå¤š' : 'åšç©º'"></td>
                            <td class="py-1.5 px-2 text-text-muted" x-text="new Date(trade.entryTime).toLocaleDateString()"></td>
                            <td class="py-1.5 px-2 text-right" :class="parseFloat(trade.returnPct) >= 0 ? 'text-positive' : 'text-negative'" x-text="(parseFloat(trade.returnPct) * 100).toFixed(2) + '%'"></td>
                            <td class="py-1.5 px-2 text-text-muted" x-text="trade.exitReason"></td>
                        </tr>
                    </template>
                    </tbody>
                </table>
            </div>
            <!-- åˆ†é æ§åˆ¶ -->
            <div class="flex items-center justify-center gap-3 mt-3" x-show="totalTradePages > 1">
                <button @click="tradePage = Math.max(1, tradePage-1)" :disabled="tradePage <= 1"
                        class="pixel-btn text-[11px] py-1 px-3 disabled:opacity-30">&#9664; ä¸Šä¸€é </button>
                <button @click="tradePage = Math.min(totalTradePages, tradePage+1)" :disabled="tradePage >= totalTradePages"
                        class="pixel-btn text-[11px] py-1 px-3 disabled:opacity-30">ä¸‹ä¸€é  &#9654;</button>
            </div>
        </div>
    </div>

    <!-- ===== å›æ¸¬æ­·å²ç´€éŒ„ ===== -->
    <div class="pixel-card p-4 mt-4">
        <h3 class="text-sm text-text-heading mb-3">&#128218; æ­·å²ç´€éŒ„</h3>
        <!-- ç©ºæ­·å²æç¤º -->
        <div x-show="history.length === 0" class="text-center py-6">
            <div class="text-2xl mb-2">&#128220;</div>
            <p class="text-text-muted text-xs">å°šç„¡æŒ‘æˆ°ç´€éŒ„</p>
            <p class="text-text-muted text-[10px] mt-1">é¸æ“‡ç­–ç•¥é–‹å§‹ä½ çš„ç¬¬ä¸€å ´å†’éšªå§ï¼</p>
        </div>
        <div x-show="history.length > 0" class="overflow-x-auto scrollbar-thin">
            <table class="w-full text-xs">
                <thead>
                <tr class="text-text-muted border-b border-border-main">
                    <th scope="col" class="py-1.5 px-2 text-left">ç­–ç•¥</th>
                    <th scope="col" class="py-1.5 px-2 text-left">å¹£å°</th>
                    <th scope="col" class="py-1.5 px-2 text-left">ç‹€æ…‹</th>
                    <th scope="col" class="py-1.5 px-2 text-left">æäº¤æ™‚é–“</th>
                    <th scope="col" class="py-1.5 px-2 text-center">æ“ä½œ</th>
                </tr>
                </thead>
                <tbody>
                <template x-for="h in history" :key="h.id">
                    <tr class="border-b border-border-main/50 hover:bg-white/5">
                        <td class="py-1.5 px-2 text-text-heading" x-text="h.templateName"></td>
                        <td class="py-1.5 px-2 text-primary" x-text="h.symbol"></td>
                        <td class="py-1.5 px-2">
                            <span :class="{
                                'text-positive': h.status === 'COMPLETED',
                                'text-negative': h.status === 'FAILED',
                                'text-warning anim-flash': h.status === 'RUNNING' || h.status === 'PENDING'
                            }" x-text="h.status === 'COMPLETED' ? '&#10003; å®Œæˆ' : h.status === 'FAILED' ? '&#10007; å¤±æ•—' : '&#9881; åŸ·è¡Œä¸­'"></span>
                        </td>
                        <td class="py-1.5 px-2 text-text-muted" x-text="new Date(h.createdAt).toLocaleString()"></td>
                        <td class="py-1.5 px-2 text-center">
                            <button x-show="h.status === 'COMPLETED'"
                                    @click="loadHistoryResult(h.id)"
                                    class="pixel-btn text-[10px] py-0.5 px-2 cursor-pointer">æŸ¥çœ‹</button>
                        </td>
                    </tr>
                </template>
                </tbody>
            </table>
        </div>
    </div>

    <div x-show="message" x-cloak x-transition class="fixed bottom-4 right-4 pixel-card px-4 py-2 text-[13px] z-50"
         :class="messageType === 'success' ? 'text-positive' : 'text-negative'" x-text="message"></div>
</main>

<script th:inline="javascript">
    const _watchlist = /*[[${watchlistSymbols}]]*/ ['BTCUSDT'];
    const _readySymbols = /*[[${readySymbols}]]*/ ['BTCUSDT'];
    const _charClass = /*[[${charClass}]]*/ 'WARRIOR';
    const _userLevel = /*[[${userLevel}]]*/ 1;
    const watchlistSymbolList = [...new Set([..._watchlist, ..._readySymbols])];
    let _symDebounce = null;
    let _lootId = 0;

    function backtestApp() {
        return {
            form: { templateId: '', symbol: watchlistSymbolList[0] || 'BTCUSDT', years: 5 },
            allTemplates: [], running: false, result: null, history: [],
            equityChart: null, historicalEvents: [], showEvents: true,
            message: '', messageType: 'success', pollPct: 0,
            tradePage: 1, tradesPerPage: 50,
            charClass: _charClass,
            partyMembers: [],
            equippedWeaponCss: null, equippedArmorCss: null,
            weaponRarity: null, armorRarity: null,
            backtestStartTime: null,
            backtestElapsedSec: 0,
            get pagedTrades() { const t = this.result?.trades || []; const s = (this.tradePage-1)*this.tradesPerPage; return t.slice(s, s+this.tradesPerPage); },
            get totalTradePages() { return Math.ceil((this.result?.trades?.length || 0) / this.tradesPerPage); },
            get estimatedTime() {
                if (!this.backtestStartTime || this.pollPct <= 0) {
                    const mins = {1: '1~3', 2: '3~8', 3: '5~12', 5: '8~20'}[this.form.years] || '5~15';
                    return '\u23F1 \u9810\u4F30 ' + mins + ' \u5206\u9418';
                }
                const elapsed = (Date.now() - this.backtestStartTime) / 1000;
                const elapsedMin = Math.floor(elapsed / 60);
                const elapsedSec = Math.floor(elapsed % 60);
                const elapsedStr = elapsedMin > 0 ? elapsedMin + '\u5206' + elapsedSec + '\u79D2' : elapsedSec + '\u79D2';
                return '\u23F1 \u5DF2\u904E ' + elapsedStr;
            },

            // â”€â”€ å†’éšªå‹•ç•«ç‹€æ…‹ â”€â”€
            advEvents: [],
            advCurrentScene: 'idle', // idle | walk | attack | treasure
            advInBattle: false,      // æ˜¯å¦åœ¨æˆ°é¬¥åŠ‡å ´
            advCurrentMonster: null,
            advMonsterPct: 0,
            advPlayerHp: 100,        // è§’è‰² HP (å‹•ç•«ç”¨)
            advMonsterHp: 100,       // æ€ªç‰© HP (å‹•ç•«ç”¨)
            advPlayerAnim: 'anim-idle',
            advMonsterAnim: 'anim-monster',
            advSkillName: '',        // è§’è‰²æŠ€èƒ½å
            advMonsterSkill: '',     // æ€ªç‰©æŠ€èƒ½å
            advBattleText: '',
            advBattleWin: null,      // null=neutral, true=win, false=lose
            advDmgTexts: [],         // å‚·å®³æ•¸å­—
            advShowTreasure: false,
            advTreasurePct: 0,
            advLog: [],
            advLootTexts: [],
            advShowRewards: false,
            advRewards: null,
            advTriggered: {},
            advRunId: null,
            advSkipped: false,        // æ˜¯å¦è·³éå‹•ç•«
            advRestoredPct: 0,        // å¾ sessionStorage æ¢å¾©çš„é€²åº¦

            // â”€â”€ é«”åŠ›ç³»çµ±ç‹€æ…‹ â”€â”€
            staminaData: { stamina: 50, maxStamina: 50, userGold: 0 },
            staminaRegenText: '',
            staminaTimer: null,
            showPriestDialog: false,
            priestPraying: false,
            priestFloatTexts: [],

            get priestCost() {
                const gps = this.staminaData.goldPerStamina || 20;
                return (this.staminaData.maxStamina - this.staminaData.stamina) * gps;
            },

            // å¹£å°æœå°‹
            symQuery: watchlistSymbolList[0] || 'BTCUSDT',
            symMatches: [], symShowDrop: false, symValidating: false,
            symCustomValid: false, symCustomChecked: false,

            rarityGlowClass(rarity) {
                if (!rarity) return '';
                const map = { RARE: 'rarity-glow-rare', EPIC: 'rarity-glow-epic', LEGENDARY: 'rarity-glow-legendary' };
                return map[rarity] || '';
            },
            async init() {
                await Promise.all([this.loadTemplates(), this.loadStamina(), this.loadHistory(), this.loadPartyMembers(), this.loadEquipment()]);
                this.symSearch();
                this.restoreAdventure();
                this.startStaminaTimer();
            },

            async loadTemplates() {
                try {
                    const r = await fetch('/api/user/strategies');
                    if (r.ok) this.allTemplates = await r.json();
                    else this.showMsg('è¼‰å…¥ç­–ç•¥åˆ—è¡¨å¤±æ•—', 'error');
                } catch(e) { this.showMsg('ç¶²è·¯ç•°å¸¸', 'error'); }
            },

            // â”€â”€ å›æ¸¬æäº¤ â”€â”€
            async submitBacktest() {
                if (!this.form.templateId) return;
                // å‰ç«¯é«”åŠ›é æª¢
                if (this.staminaData.stamina < this.form.years) {
                    this.showMsg(`é«”åŠ›ä¸è¶³ï¼éœ€è¦ ${this.form.years} é»ï¼Œç›®å‰ ${this.staminaData.stamina} é»`, 'error');
                    return;
                }
                this.running = true; this.result = null;
                this.backtestStartTime = Date.now();
                this.advShowRewards = false; this.advRewards = null;
                this.advLog = []; this.advTriggered = {}; this.advEvents = [];
                this.advCurrentScene = 'walk'; this.advSkipped = false;
                try {
                    const r = await fetch('/api/user/backtest/run', {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(this.form)
                    });
                    if (!r.ok) {
                        try { const e = await r.json(); this.showMsg(e.error || 'æäº¤å¤±æ•—', 'error'); }
                        catch(_) { this.showMsg('æäº¤å¤±æ•—', 'error'); }
                        this.running = false; this.advCurrentScene = 'idle'; return;
                    }
                    const data = await r.json();
                    this.advRunId = data.id;

                    // è§£æå†’éšªè¨ˆç•«
                    try {
                        const plan = JSON.parse(data.adventureJson || '{}');
                        this.advEvents = plan.events || [];
                    } catch(e) { this.advEvents = []; }

                    this.addLog('âš” å†’éšªé–‹å§‹ï¼å‹‡å£«è¸ä¸Šå¾é€”...', 'text-primary');
                    this.saveAdventure();
                    this.showMsg('æŒ‘æˆ°å·²é–‹å§‹...', 'success');
                    await this.loadStamina(); // åˆ·æ–°é«”åŠ›é¡¯ç¤º
                    await this.pollResult(data.id);
                } catch(e) { this.showMsg('ç¶²è·¯éŒ¯èª¤', 'error'); this.running = false; this.advCurrentScene = 'idle'; }
            },

            // â”€â”€ è¼ªè©¢çµæœ + è§¸ç™¼å†’éšªäº‹ä»¶ â”€â”€
            async pollResult(runId) {
                // å•Ÿå‹•è‡ªå‹•å„²å­˜ï¼ˆæ¯ 3 ç§’æŒçºŒå¯«å…¥ sessionStorageï¼‰
                const autoSave = setInterval(() => this.saveAdventure(), 3000);

                try {
                    // ä½¿ç”¨æ¢å¾©çš„é€²åº¦ä½œç‚ºèµ·é»
                    const startI = Math.floor((this.advRestoredPct / 100) * 120);
                    if (startI === 0) this.pollPct = 0;
                    this.advRestoredPct = 0;

                    for (let i = startI; i < 120; i++) {
                        if (this.advSkipped) break;
                        this.pollPct = Math.min(99, Math.round((i / 120) * 100));
                        if (!this.advInBattle) this.advCurrentScene = 'walk';

                        if (!this.advSkipped) await this.checkMilestones();

                        await new Promise(r => setTimeout(r, 2000));
                        if (this.advSkipped) break;

                        try {
                            const r = await fetch(`/api/user/backtest/${runId}`);
                            if (!r.ok) continue;
                            const d = await r.json();
                            if (d.status === 'COMPLETED') {
                                clearInterval(autoSave);
                                await this.handleComplete(d, runId);
                                return;
                            } else if (d.status === 'FAILED') {
                                clearInterval(autoSave);
                                this.running = false; this.pollPct = 0;
                                this.advCurrentScene = 'idle'; this.advInBattle = false;
                                this.addLog('âŒ å›æ¸¬è¨ˆç®—å¤±æ•—', 'text-negative');
                                this.showMsg('å›æ¸¬å¤±æ•—', 'error');
                                this.clearSavedAdventure();
                                return;
                            }
                        } catch(e) {}
                    }

                    // è·³éæ¨¡å¼æˆ–å‹•ç•«è·‘å®Œï¼šæŒçºŒè¼ªè©¢ç›´åˆ°å›æ¸¬å®Œæˆ
                    this.advInBattle = false;
                    this.advCurrentScene = 'idle';
                    if (this.advSkipped) this.addLog('â© å·²è·³éå†’éšªå‹•ç•«ï¼Œç­‰å¾…å›æ¸¬å®Œæˆ...', 'text-text-muted');

                    for (let j = 0; j < 300; j++) {
                        this.pollPct = Math.min(99, this.pollPct + 1);
                        await new Promise(r => setTimeout(r, 1000));
                        try {
                            const r = await fetch(`/api/user/backtest/${runId}`);
                            if (!r.ok) continue;
                            const d = await r.json();
                            if (d.status === 'COMPLETED') {
                                clearInterval(autoSave);
                                await this.handleComplete(d, runId);
                                return;
                            } else if (d.status === 'FAILED') {
                                clearInterval(autoSave);
                                this.running = false; this.pollPct = 0;
                                this.showMsg('å›æ¸¬å¤±æ•—', 'error');
                                this.clearSavedAdventure();
                                return;
                            }
                        } catch(e) {}
                    }
                    clearInterval(autoSave);
                    this.running = false; this.pollPct = 0; this.advCurrentScene = 'idle';
                    this.showMsg('è¶…æ™‚', 'error');
                    this.clearSavedAdventure();
                } catch(e) {
                    clearInterval(autoSave);
                    throw e;
                }
            },

            async handleComplete(d, runId) {
                this.pollPct = 100;
                this.result = JSON.parse(d.resultJson);
                this.running = false;
                this.backtestElapsedSec = this.backtestStartTime ? Math.round((Date.now() - this.backtestStartTime) / 1000) : 0;
                this.backtestStartTime = null;
                this.advCurrentScene = 'idle';
                this.advInBattle = false;

                if (!this.advSkipped) {
                    await this.checkMilestones();
                }

                this.addLog(this.result.passed ? 'ğŸ† å†’éšªå®Œæˆï¼è‹±é›„å‡±æ—‹æ­¸ä¾†ï¼' : 'âš” å†’éšªå®Œæˆï¼è‹±é›„å¸¶è‘—ç¶“é©—æ­¸ä¾†...', this.result.passed ? 'text-positive' : 'text-text-heading');

                if (!d.adventureRewardsClaimed) {
                    await this.claimRewards(runId);
                }

                this.showMsg('å›æ¸¬å®Œæˆï¼', 'success');
                this.$nextTick(() => this.renderChart());
                this.clearSavedAdventure();
                await this.loadHistory();
                await this.loadStamina();
            },

            // â”€â”€ è·³éå‹•ç•« â”€â”€
            skipAdventure() {
                this.advSkipped = true;
                this.advInBattle = false;
                this.advCurrentScene = 'idle';
            },

            // â”€â”€ é‡Œç¨‹ç¢‘æª¢æŸ¥ + å‹•ç•«è§¸ç™¼ â”€â”€
            async checkMilestones() {
                for (const evt of this.advEvents) {
                    if (this.pollPct >= evt.pct && !this.advTriggered[evt.pct]) {
                        this.advTriggered[evt.pct] = true;
                        if (evt.type === 'MONSTER') {
                            await this.playMonsterEncounter(evt);
                        } else if (evt.type === 'TREASURE') {
                            await this.playTreasureEvent(evt);
                        }
                    }
                }
            },

            // â”€â”€ æŠ€èƒ½åº« â”€â”€
            SKILLS: {
                WARRIOR: ['çŒ›æ“Š', 'ç›¾ç‰Œè¡æ’', 'æ—‹é¢¨æ–¬', 'ç ´ç”²é‡æ“Š', 'å¤©å´©åœ°è£‚'],
                MAGE: ['ç«çƒè¡“', 'å†°éœœæ–°æ˜Ÿ', 'é›·é›»éˆ', 'éš•çŸ³è¡“', 'æ™‚é–“åœæ­¢'],
                RANGER: ['ç²¾æº–å°„æ“Š', 'å¤šé‡ç®­', 'ç©¿é€å°„æ“Š', 'æš´é¢¨ç®­é›¨', 'é·¹çœ¼ç‹™æ®º'],
                ASSASSIN: ['èƒŒåˆº', 'æ¯’åˆƒ', 'å½±æ­¥', 'è‡´å‘½é€£æ“Š', 'æš—å½±çµæ®º']
            },
            MONSTER_SKILLS: ['æ’•å’¬', 'çŒ›æ’²', 'æ¯’éœ§', 'æš—å½±è¡æ“Š', 'åœ°ç„ç«ç„°', 'å†°å‡åæ¯', 'é›·æ“Š', 'æ—‹é¢¨çˆª'],

            pickSkill() {
                const skills = this.SKILLS[this.charClass] || this.SKILLS.WARRIOR;
                return skills[Math.floor(Math.random() * skills.length)];
            },
            pickMonsterSkill() {
                return this.MONSTER_SKILLS[Math.floor(Math.random() * this.MONSTER_SKILLS.length)];
            },

            // â”€â”€ æ€ªç‰©é­é‡å‹•ç•«ï¼ˆå¤šå›åˆ RPG æˆ°é¬¥ï¼‰ â”€â”€
            async playMonsterEncounter(evt) {
                // é€²å…¥æˆ°é¬¥åŠ‡å ´
                this.advCurrentScene = 'idle';
                this.advInBattle = true;
                this.advCurrentMonster = evt;
                this.advMonsterPct = evt.pct;
                this.advPlayerHp = 100;
                this.advMonsterHp = 100;
                this.advPlayerAnim = 'anim-idle';
                this.advMonsterAnim = 'anim-monster';
                this.advBattleText = '';
                this.advSkillName = '';
                this.advMonsterSkill = '';

                this.addLog(`âš  é­é‡ ${evt.monsterName}ï¼ˆLv.${evt.monsterLevel}ãƒ»${evt.riskTier}ï¼‰ï¼`, 'text-cta');
                await this.sleep(1000);

                // å‰ç«¯æ¼”å‡ºå‹æ•—ï¼ˆå¯¦éš›çå‹µç”±å¾Œç«¯æ±ºå®šï¼‰
                const win = Math.random() < 0.6;
                const rounds = 2 + Math.floor(Math.random() * 2); // 2~3 å›åˆ

                // æ ¹æ“šå‹æ•—æ±ºå®šå‚·å®³ç¯„åœï¼Œç¢ºä¿å‹•ç•«èˆ‡çµæœä¸€è‡´
                const pDmgBase = win ? 25 : 10;  // å‹åˆ©æ™‚è§’è‰²å‚·å®³é«˜
                const mDmgBase = win ? 8 : 22;   // å¤±æ•—æ™‚æ€ªç‰©å‚·å®³é«˜

                for (let round = 1; round <= rounds; round++) {
                    // === è§’è‰²å›åˆ ===
                    const skill = this.pickSkill();
                    this.advSkillName = skill;
                    this.advBattleText = `${this.charClass} ä½¿ç”¨äº† ${skill}ï¼`;
                    this.addLog(`âš” Round ${round}ï¼š${skill}ï¼`, 'text-cta');
                    await this.sleep(600);

                    // è§’è‰²æ”»æ“Šå‹•ç•«
                    this.advPlayerAnim = 'anim-attack';
                    await this.sleep(500);
                    this.advPlayerAnim = 'anim-idle';
                    this.advSkillName = '';

                    // æ€ªç‰©å—å‚·ï¼ˆå‹åˆ©æ™‚å‚·å®³æ›´é«˜ï¼‰
                    const pDmg = pDmgBase + Math.floor(Math.random() * 15);
                    this.advMonsterAnim = 'anim-hurt';
                    this.spawnDmg(65, `-${pDmg}`, 'text-negative');
                    this.advMonsterHp = Math.max(0, this.advMonsterHp - pDmg);
                    await this.sleep(600);
                    this.advMonsterAnim = 'anim-monster';

                    // å‹åˆ©ï¼šæ€ªç‰© HP æ­¸é›¶æ™‚çµæŸ
                    if (win && this.advMonsterHp <= 0) {
                        this.advMonsterHp = 0;
                        break;
                    }

                    await this.sleep(400);

                    // === æ€ªç‰©å›åˆ ===
                    const mSkill = this.pickMonsterSkill();
                    this.advMonsterSkill = mSkill;
                    this.advBattleText = `${evt.monsterName} ä½¿ç”¨äº† ${mSkill}ï¼`;
                    this.addLog(`ğŸ’€ ${evt.monsterName} åæ“Šï¼š${mSkill}ï¼`, 'text-negative');
                    await this.sleep(600);

                    // æ€ªç‰©æ”»æ“Šå‹•ç•«
                    this.advMonsterAnim = 'anim-m-attack';
                    await this.sleep(500);
                    this.advMonsterAnim = 'anim-monster';
                    this.advMonsterSkill = '';

                    // è§’è‰²å—å‚·ï¼ˆå¤±æ•—æ™‚æ€ªç‰©å‚·å®³æ›´é«˜ï¼‰
                    const mDmg = mDmgBase + Math.floor(Math.random() * 12);
                    this.advPlayerAnim = 'anim-hurt';
                    this.spawnDmg(30, `-${mDmg}`, 'text-negative');
                    this.advPlayerHp = Math.max(3, this.advPlayerHp - mDmg);
                    await this.sleep(600);
                    this.advPlayerAnim = 'anim-idle';
                    await this.sleep(300);
                }

                // === çµç®—ï¼šç¢ºä¿ HP åæ˜ çµæœ ===
                await this.sleep(400);
                if (win) {
                    this.advMonsterHp = 0;
                    this.advMonsterAnim = 'anim-hurt';
                    this.advBattleText = `&#9989; ${evt.monsterName} è¢«æ“Šæ•—äº†ï¼`;
                    this.advBattleWin = true;
                    this.addLog(`âœ… æ“Šæ•— ${evt.monsterName}ï¼ç²å¾—ç¶“é©—èˆ‡é‡‘å¹£`, 'text-positive');
                    this.spawnLoot(evt.pct, '+EXP +Gold', 'text-primary');
                } else {
                    this.advPlayerHp = Math.max(3, Math.min(15, this.advPlayerHp));
                    this.advMonsterHp = Math.max(20, this.advMonsterHp); // æ€ªç‰©ä»æœ‰è¡€
                    this.advBattleText = `&#10060; è¢« ${evt.monsterName} æ“Šé€€...`;
                    this.advBattleWin = false;
                    this.addLog(`âŒ è¢« ${evt.monsterName} æ“Šé€€... æå¤±é‡‘å¹£`, 'text-negative');
                }
                await this.sleep(2000);

                // é€€å‡ºæˆ°é¬¥åŠ‡å ´
                this.advBattleText = '';
                this.advBattleWin = null;
                this.advCurrentMonster = null;
                this.advInBattle = false;
                this.advCurrentScene = 'walk';
            },

            // â”€â”€ å¯¶ç®±äº‹ä»¶å‹•ç•« â”€â”€
            async playTreasureEvent(evt) {
                this.advCurrentScene = 'idle';
                this.advShowTreasure = true;
                this.advTreasurePct = evt.pct;
                this.addLog(`ğŸ ç™¼ç¾å¯¶ç®±ï¼ç²å¾— ${evt.goldAmount} G`, 'text-primary');
                this.spawnLoot(evt.pct, `+${evt.goldAmount} G`, 'text-primary');
                await this.sleep(2500);
                this.advShowTreasure = false;
                this.advCurrentScene = 'walk';
            },

            // â”€â”€ é£„å­—æ•ˆæœ â”€â”€
            spawnLoot(x, text, color) {
                const id = ++_lootId;
                this.advLootTexts.push({ id, x, text, color });
                setTimeout(() => { this.advLootTexts = this.advLootTexts.filter(l => l.id !== id); }, 1500);
            },
            spawnDmg(x, text, color) {
                const id = ++_lootId;
                this.advDmgTexts.push({ id, x, text, color });
                setTimeout(() => { this.advDmgTexts = this.advDmgTexts.filter(d => d.id !== id); }, 1200);
            },
            addLog(text, color) {
                this.advLog.push({ text, color });
                this.$nextTick(() => {
                    const box = this.$refs.advLogBox;
                    if (box) box.scrollTop = box.scrollHeight;
                });
            },

            // â”€â”€ é ˜å–çå‹µ â”€â”€
            async claimRewards(runId) {
                try {
                    const r = await fetch(`/api/user/backtest/${runId}/adventure/claim`, { method: 'POST' });
                    if (r.ok) {
                        this.advRewards = await r.json();
                        this.advShowRewards = true;
                        this.addLog(`ğŸ‰ ç²å¾— ${this.advRewards.exp} EXP, ${this.advRewards.gold} G`, 'text-primary');
                    }
                } catch(e) {
                    console.error('Failed to claim adventure rewards', e);
                }
            },

            // â”€â”€ sessionStorage æŒä¹…åŒ– â”€â”€
            saveAdventure() {
                try {
                    sessionStorage.setItem('btc_adventure', JSON.stringify({
                        runId: this.advRunId, events: this.advEvents,
                        triggered: this.advTriggered, log: this.advLog,
                        pollPct: this.pollPct, running: this.running
                    }));
                } catch(e) {}
            },
            restoreAdventure() {
                try {
                    const saved = sessionStorage.getItem('btc_adventure');
                    if (!saved) return;
                    const s = JSON.parse(saved);
                    if (!s.running || !s.runId) { this.clearSavedAdventure(); return; }

                    // æ¢å¾©ç‹€æ…‹
                    this.advRunId = s.runId;
                    this.advEvents = s.events || [];
                    this.advTriggered = s.triggered || {};
                    this.advLog = s.log || [];
                    this.running = true;
                    this.advCurrentScene = 'walk';
                    this.pollPct = s.pollPct || 0;
                    this.advRestoredPct = s.pollPct || 0; // å‘Šè¨´ pollResult å¾é€™è£¡é–‹å§‹

                    this.addLog('ğŸ”„ æ¢å¾©å†’éšªé€²åº¦...', 'text-text-muted');

                    // ç¹¼çºŒè¼ªè©¢
                    this.pollResult(s.runId);
                } catch(e) { this.clearSavedAdventure(); }
            },
            clearSavedAdventure() {
                try { sessionStorage.removeItem('btc_adventure'); } catch(e) {}
            },

            sleep(ms) { return new Promise(r => setTimeout(r, ms)); },

            async renderChart() {
                const canvas = document.getElementById('equityChart');
                if (!canvas || !this.result?.equityCurve) return;
                if (this.equityChart) this.equityChart.destroy();
                const curve = this.result.equityCurve;
                const step = Math.max(1, Math.floor(curve.length / 500));
                const sampled = curve.filter((_, i) => i % step === 0);
                const initEquity = sampled.length > 0 ? parseFloat(sampled[0].equity) : 1;
                const labels = sampled.map(p => new Date(p.time).toLocaleDateString());

                // è¼‰å…¥æ­·å²äº‹ä»¶
                let annotations = {};
                if (this.showEvents && this.result.startDate && this.result.endDate) {
                    try {
                        const resp = await fetch('/api/market/events?start=' + this.result.startDate + '&end=' + this.result.endDate);
                        if (resp.ok) {
                            this.historicalEvents = await resp.json();
                            const catColors = { halving: '#F59E0B', bullish: '#22c55e', bearish: '#ef4444', regulation: '#3b82f6' };
                            this.historicalEvents.forEach((evt, i) => {
                                const evtDate = new Date(evt.timestamp).toLocaleDateString();
                                const idx = labels.indexOf(evtDate);
                                if (idx === -1) {
                                    // æ‰¾æœ€æ¥è¿‘çš„æ¨™ç±¤
                                    const evtMs = new Date(evt.timestamp).getTime();
                                    let closestIdx = 0, closestDiff = Infinity;
                                    for (let j = 0; j < sampled.length; j++) {
                                        const diff = Math.abs(new Date(sampled[j].time).getTime() - evtMs);
                                        if (diff < closestDiff) { closestDiff = diff; closestIdx = j; }
                                    }
                                    if (closestDiff < 7 * 86400000) {
                                        annotations['event' + i] = {
                                            type: 'line', scaleID: 'x', value: labels[closestIdx],
                                            borderColor: catColors[evt.category] || '#94a3b8',
                                            borderWidth: 1, borderDash: [4, 2],
                                            label: { display: true, content: evt.title,
                                                font: { size: 8, family: '"Exo 2"' },
                                                backgroundColor: 'rgba(15,23,42,0.85)', color: catColors[evt.category] || '#94a3b8',
                                                position: i % 2 === 0 ? 'start' : 'end', rotation: -90, padding: 2 }
                                        };
                                    }
                                } else {
                                    annotations['event' + i] = {
                                        type: 'line', scaleID: 'x', value: evtDate,
                                        borderColor: catColors[evt.category] || '#94a3b8',
                                        borderWidth: 1, borderDash: [4, 2],
                                        label: { display: true, content: evt.title,
                                            font: { size: 8, family: '"Exo 2"' },
                                            backgroundColor: 'rgba(15,23,42,0.85)', color: catColors[evt.category] || '#94a3b8',
                                            position: i % 2 === 0 ? 'start' : 'end', rotation: -90, padding: 2 }
                                    };
                                }
                            });
                        }
                    } catch(e) { /* éœé»˜å¤±æ•— */ }
                }

                this.equityChart = new Chart(canvas.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [{
                            label: 'å ±é…¬ç‡',
                            data: sampled.map(p => ((parseFloat(p.equity) - initEquity) / initEquity * 100)),
                            borderColor: '#a855f7', backgroundColor: 'rgba(168,85,247,0.1)',
                            borderWidth: 2, fill: true, tension: 0, pointRadius: 0, stepped: 'before'
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: '#16213e', titleColor: '#e8e8f0', bodyColor: '#7a7a9a',
                                borderColor: '#2a2a4a', borderWidth: 2,
                                titleFont: { family: '"Exo 2"', size: 12 },
                                bodyFont: { family: '"Exo 2"', size: 11 },
                                callbacks: { label: ctx => ctx.parsed.y.toFixed(2) + '%' }
                            },
                            annotation: { annotations }
                        },
                        scales: {
                            x: { display: true, ticks: { color: '#7a7a9a', maxTicksLimit: 6, font: { family: '"Exo 2"', size: 10 } }, grid: { color: 'rgba(42,42,74,0.3)' } },
                            y: { display: true, ticks: { color: '#7a7a9a', font: { family: '"Exo 2"', size: 10 }, callback: v => v.toFixed(1) + '%' }, grid: { color: 'rgba(42,42,74,0.3)' } }
                        }
                    }
                });
            },

            showMsg(m, t) { this.message = m; this.messageType = t; setTimeout(() => { this.message = ''; }, 4000); },

            // â”€â”€ å¹£å°æœå°‹æ–¹æ³• â”€â”€
            symSearch() {
                const q = this.symQuery.toUpperCase().trim();
                this.symCustomValid = false; this.symCustomChecked = false;
                if (!q) { this.symMatches = watchlistSymbolList.slice(0, 20); return; }
                this.symMatches = watchlistSymbolList.filter(s => s.includes(q)).slice(0, 20);
                if (watchlistSymbolList.includes(q)) { this.form.symbol = q; return; }
                if (q.length >= 3 && this.symMatches.length === 0) {
                    clearTimeout(_symDebounce);
                    _symDebounce = setTimeout(() => this.symValidateCustom(q), 500);
                }
            },
            async symValidateCustom(symbol) {
                this.symValidating = true;
                try {
                    const r = await fetch('/api/symbols/validate?symbol=' + encodeURIComponent(symbol));
                    if (r.ok) { const d = await r.json(); this.symCustomValid = d.valid; this.symCustomChecked = true; }
                } catch(e) { this.symCustomChecked = true; }
                finally { this.symValidating = false; }
            },
            symPick(s) { this.symQuery = s; this.form.symbol = s; this.symShowDrop = false; },
            async symPickCustom() {
                const symbol = this.symQuery.toUpperCase().trim();
                try {
                    const r = await fetch('/api/symbols', { method: 'POST', headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({ symbol: symbol, displayName: symbol.replace('USDT','') + '/USDT' }) });
                    if (r.ok) {
                        watchlistSymbolList.push(symbol);
                        this.form.symbol = symbol; this.symShowDrop = false;
                        toast('å·²æ–°å¢ ' + symbol + 'ï¼Œè³‡æ–™åŒæ­¥ä¸­...', 'success');
                    } else {
                        const d = await r.json();
                        if (d.error?.includes('å·²åœ¨è¿½è¹¤')) {
                            if (!watchlistSymbolList.includes(symbol)) watchlistSymbolList.push(symbol);
                            this.form.symbol = symbol; this.symShowDrop = false;
                            toast(symbol + ' å·²åœ¨è¿½è¹¤ä¸­', 'info');
                        } else { toast(d.error || 'æ–°å¢å¤±æ•—', 'error'); }
                    }
                } catch(e) { toast('æ–°å¢å¤±æ•—', 'error'); }
            },

            // â”€â”€ æ­·å²ç´€éŒ„æ–¹æ³• â”€â”€
            async loadHistory() {
                try {
                    const r = await fetch('/api/user/backtest/history');
                    if (r.ok) this.history = await r.json();
                } catch(e) {}
            },
            async loadPartyMembers() {
                try {
                    const r = await fetch('/api/user/equipment/party-members');
                    if (r.ok) this.partyMembers = await r.json();
                } catch(e) {}
            },
            async loadEquipment() {
                try {
                    const r = await fetch('/api/user/equipment/summary');
                    if (r.ok) {
                        const eq = await r.json();
                        this.equippedWeaponCss = eq.equippedWeaponCss;
                        this.equippedArmorCss = eq.equippedArmorCss;
                        this.weaponRarity = eq.equippedWeaponRarity;
                        this.armorRarity = eq.equippedArmorRarity;
                    }
                } catch(e) {}
            },

            async loadHistoryResult(id) {
                try {
                    const r = await fetch(`/api/user/backtest/${id}`);
                    if (!r.ok) return;
                    const d = await r.json();
                    if (d.status === 'COMPLETED' && d.resultJson) {
                        this.result = JSON.parse(d.resultJson);
                        this.tradePage = 1;
                        this.advShowRewards = false;
                        this.$nextTick(() => this.renderChart());
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                } catch(e) { this.showMsg('è¼‰å…¥å¤±æ•—', 'error'); }
            },

            // â”€â”€ é«”åŠ›ç³»çµ±æ–¹æ³• â”€â”€
            async loadStamina() {
                try {
                    const r = await fetch('/api/user/backtest/stamina');
                    if (r.ok) this.staminaData = await r.json();
                } catch(e) {}
                this.updateRegenText();
            },

            updateRegenText() {
                if (this.staminaData.stamina >= this.staminaData.maxStamina) {
                    this.staminaRegenText = '';
                    return;
                }
                const nextRegen = this.staminaData.nextRegenAt;
                if (!nextRegen) { this.staminaRegenText = 'å›å¾©ä¸­...'; return; }
                const diff = Math.max(0, Math.floor((new Date(nextRegen) - Date.now()) / 1000));
                const m = Math.floor(diff / 60);
                const s = diff % 60;
                this.staminaRegenText = `ä¸‹æ¬¡å›å¾©: ${m}:${String(s).padStart(2, '0')}`;
            },

            startStaminaTimer() {
                if (this.staminaTimer) clearInterval(this.staminaTimer);
                this.staminaTimer = setInterval(() => {
                    this.updateRegenText();
                    // æª¢æŸ¥æ˜¯å¦è©²å›å¾©äº†
                    if (this.staminaData.nextRegenAt && new Date(this.staminaData.nextRegenAt) <= Date.now()) {
                        this.loadStamina();
                    }
                }, 1000);
            },

            async priestRestore() {
                this.priestPraying = true;
                this.priestFloatTexts = [];

                // é£„å­—å‹•ç•«
                let pfId = 0;
                const texts = ['&#10013;', '+HP', '&#9769;', '&#10024;'];
                for (const t of texts) {
                    const id = ++pfId;
                    this.priestFloatTexts.push({ id, x: 30 + Math.random() * 40, text: t });
                    await this.sleep(400);
                }

                try {
                    const r = await fetch('/api/user/backtest/stamina/restore', {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ amount: this.staminaData.maxStamina })
                    });
                    if (r.ok) {
                        const data = await r.json();
                        this.staminaData.stamina = data.stamina;
                        this.staminaData.maxStamina = data.maxStamina;
                        this.staminaData.userGold = data.userGold;
                        await this.sleep(1000);
                        this.showMsg(`ç¥çˆ¶ç¥ˆç¦±ï¼æ¢å¾© ${data.restored} é»é«”åŠ› (-${data.goldSpent} G)`, 'success');
                    } else {
                        const e = await r.json();
                        this.showMsg(e.error || 'æ¢å¾©å¤±æ•—', 'error');
                    }
                } catch(e) { this.showMsg('ç¶²è·¯éŒ¯èª¤', 'error'); }

                this.priestPraying = false;
                this.priestFloatTexts = [];
                this.showPriestDialog = false;
                await this.loadStamina();
            }
        };
    }
</script>
</body>
</html>
